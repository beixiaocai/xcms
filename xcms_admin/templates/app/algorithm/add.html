{% extends "app/base_site.html" %}
{% block title %} {% if  "add" == handle %}添加{% else %}编辑{% endif %}基础算法 {% endblock title %}
{% block stylesheets %}
  {{ block.super }}
<style>
    /* 基础算法信息卡片 */
    .alg_info_card {
        background: #fff;
        border-radius: 8px;
        padding: 20px 24px;
        margin: 0 auto 16px;
        max-width: 900px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .alg_card_title {
        font-size: 14px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        padding-bottom: 12px;
        border-bottom: 1px solid #eef2f5;
    }
    
    .alg_card_title i {
        margin-right: 8px;
        color: #169F85;
        font-size: 16px;
    }
    
    /* 表单组优化 */
    .alg_form_group {
        margin-bottom: 16px;
    }
    
    .alg_form_label {
        font-size: 12px;
        color: #606266;
        font-weight: 500;
        margin-bottom: 6px;
        display: block;
    }
    
    .alg_form_label .required {
        color: #f56c6c;
        margin-left: 2px;
    }
    
    .alg_form_label .bxc_introduce {
        margin-left: 4px;
        color: #909399;
        cursor: help;
    }
    
    .alg_form_control {
        width: 100%;
    }
    
    .alg_input, .alg_select, .alg_textarea {
        width: 100%;
        padding: 8px 12px;
        font-size: 13px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        transition: border-color 0.2s;
        background: #fff;
    }
    
    .alg_input {
        height: 36px;
    }
    
    .alg_select {
        height: 36px;
    }
    
    .alg_textarea {
        resize: vertical;
        font-family: inherit;
    }
    
    .alg_input:focus, .alg_select:focus, .alg_textarea:focus {
        border-color: #169F85;
        outline: none;
    }
    
    .alg_input:disabled, .alg_select:disabled, .alg_textarea:disabled,
    .alg_input[readonly], .alg_select[readonly], .alg_textarea[readonly] {
        background: #f5f7fa;
        color: #909399;
        cursor: not-allowed;
    }
    
    /* 文件上传样式 - 基于默认样式简洁美化 */
    .alg_file_wrapper {
        position: relative;
    }
    
    .alg_file_wrapper input[type="file"] {
        width: 100%;
        padding: 6px 12px;
        font-size: 12px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s;
        height: 36px;
    }
    
    .alg_file_wrapper input[type="file"]:hover {
        border-color: #169F85;
    }
    
    .alg_file_wrapper input[type="file"]:focus {
        outline: none;
        border-color: #169F85;
        box-shadow: 0 0 0 2px rgba(22, 159, 133, 0.1);
    }
    
    .alg_file_wrapper input[type="file"]::file-selector-button {
        padding: 4px 12px;
        margin-right: 12px;
        font-size: 12px;
        color: #606266;
        background: #f5f7fa;
        border: 1px solid #dcdfe6;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .alg_file_wrapper input[type="file"]::file-selector-button:hover {
        color: #169F85;
        border-color: #169F85;
        background: #f0f9f6;
    }
    
    /* 状态标签 */
    .sun-state-success {
        color: #169F85;
        font-weight: 500;
    }
    
    .sun-state-error {
        color: #f56c6c;
        font-weight: 500;
    }
    
    /* 按钮组 */
    .alg_actions {
        text-align: center;
        padding-top: 24px;
        border-top: 1px solid #eef2f5;
        margin-top: 8px;
    }
    
    .alg_btn {
        min-width: 100px;
        height: 38px;
        padding: 0 24px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        margin: 0 8px;
    }
    
    .alg_btn_cancel {
        background: #fff;
        border: 1px solid #dcdfe6;
        color: #606266;
    }
    
    .alg_btn_cancel:hover {
        color: #169F85;
        border-color: #169F85;
        background: #f0f9f6;
    }
    
    .alg_btn_submit {
        background: linear-gradient(135deg, #169F85 0%, #14b89a 100%);
        color: #fff;
    }
    
    .alg_btn_submit:hover {
        box-shadow: 0 3px 8px rgba(22, 159, 133, 0.3);
        transform: translateY(-1px);
    }
    
    .alg_btn_log {
        background: #fff;
        border: 1px solid #dcdfe6;
        color: #606266;
        font-size: 12px;
        padding: 4px 12px;
        height: auto;
        min-width: auto;
    }
    
    .alg_btn_log:hover {
        color: #169F85;
        border-color: #169F85;
    }
    
    /* 加载提示 */
    #top_loading {
        display: none;
        margin-left: 16px;
        color: #909399;
        font-size: 13px;
    }
    
    #top_loading img {
        width: 16px;
        height: 16px;
        margin-right: 6px;
        vertical-align: middle;
    }
    
    #timer_counter, #submit_msg {
        font-size: 12px;
        color: #606266;
        margin-left: 8px;
    }
</style>
{% endblock stylesheets %}

{% block content %}
  <div class="right_col" role="main">
    <div class="">
      <div class="row">
        <div class="col-md-12 col-xs-12">
          <div class="x_panel">
            <div class="x_title">
                <h2>{% if  "add" == handle %}添加{% else %}编辑{% endif %}基础算法 <span id="top_msg">{{top_msg}}</span>
              <!--
                <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </li>
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                  <ul class="dropdown-menu" role="menu">
                    <li><a href="#">Settings 1</a>
                    </li>
                    <li><a href="#">Settings 2</a>
                    </li>
                  </ul>
                </li>
                <li><a class="close-link"><i class="fa fa-close"></i></a>
                </li>
              </ul>
            -->
                </h2>
              <div class="clearfix"></div>
            </div>
            <div class="x_content">
              
              <!-- 基础算法配置卡片 -->
              <div class="alg_info_card">
                <div class="alg_card_title">
                  <i class="fa fa-cube"></i>基础算法配置
                </div>
                
                <div class="alg_form_group">
                  <label class="alg_form_label">算法编号</label>
                  <div class="alg_form_control">
                    <input type="text" value="{{ algorithm.code }}" class="alg_input" disabled>
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">算法名称<span class="required">*</span></label>
                  <div class="alg_form_control">
                    <input type="text" name="name" value="{{ algorithm.name }}" class="alg_input" placeholder="请输入算法名称">
                  </div>
                </div>

                {% if "edit" == handle %}<input type="hidden" name="algorithm_type" value="{{ algorithm.algorithm_type }}">{% endif %}
                <div class="alg_form_group">
                  <label class="alg_form_label">请选择算法类型<span class="required">*</span></label>
                  <div class="alg_form_control">
                    <select name="algorithm_type" {% if "edit" == handle %}disabled{% endif %} class="alg_select">
                      <option value="0">请选择</option>
                      {% for algorithm_type in algorithm_types %}
                        {% if algorithm.algorithm_type == algorithm_type.code %}
                          <option selected value="{{ algorithm.algorithm_type }}">{{ algorithm_type.name }}</option>
                        {% else %}
                          <option value="{{ algorithm_type.code }}">{{ algorithm_type.name }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">算法框架<span class="required">*</span></label>
                  <div class="alg_form_control">
                    {% if "edit" == handle %}
                      <select disabled name="framework" class="alg_select">
                        <option>{{ algorithm.framework }}</option>
                      </select>
                    {% else %}
                      <select name="framework" class="alg_select"></select>
                    {% endif %}
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">推理引擎<span class="required">*</span></label>
                  <div class="alg_form_control">
                    {% if "edit" == handle %}
                      <select disabled name="inference" class="alg_select">
                        <option>{{ algorithm.inference }}</option>
                      </select>
                    {% else %}
                      <select name="inference" class="alg_select"></select>
                    {% endif %}
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">
                    推理引擎设备<span class="required">*</span>
                    <i class="bxc_introduce fa fa-info-circle" title="推理引擎设备，比如CPU,GPU,GPU:0,GPU:1"></i>
                  </label>
                  <div class="alg_form_control">
                    <input type="text" name="inference_device" value="{{ algorithm.inference_device }}" class="alg_input">
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">
                    模型推理参数<span class="required">*</span>
                    <i class="bxc_introduce fa fa-info-circle" title="分析器基于模型计算时的自定义参数"></i>
                  </label>
                  <div class="alg_form_control">
                    <textarea name="extend_params" class="alg_textarea" rows="2">{{ algorithm.extend_params }}</textarea>
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">
                    模型转换参数<span class="required">*</span>
                    <i class="bxc_introduce fa fa-info-circle" title="trtexec在将onnx转换为engine的命令行扩展参数"></i>
                  </label>
                  <div class="alg_form_control">
                    <textarea name="model_convert_params" {% if "edit" == handle %}disabled{% endif %} class="alg_textarea" rows="2" placeholder="">{{ algorithm.model_convert_params }}</textarea>
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">模型目标<span class="required">*</span></label>
                  <div class="alg_form_control">
                    <textarea name="model_class_names" {% if "edit" == handle %}disabled{% endif %} class="alg_textarea" rows="4" placeholder="请填写模型支持的目标名称，如果多个名称请用英文逗号隔开。添加前，建议参考添加基础算法文档的示例">{{ algorithm.model_class_names }}</textarea>
                  </div>
                </div>

                {% if "add" == handle %}
                <div class="alg_form_group">
                  <label class="alg_form_label">模型文件<span class="required">*</span></label>
                  <div class="alg_form_control">
                    <div class="alg_file_wrapper">
                      <input type="file" name="model" id="modelFileInput" accept=".onnx,.engine,.tar,.om,.rknn" placeholder="模型文件">
                    </div>
                  </div>
                </div>
                {% elif "edit" == handle %}
                <div class="alg_form_group">
                  <label class="alg_form_label">模型目标数量</label>
                  <div class="alg_form_control">
                    <span class="sun-state-success">{{ model_class_names_len }}</span>
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">模型文件路径</label>
                  <div class="alg_form_control">
                    <input type="text" value="{{ absolute_model_dir }}" readonly class="alg_input">
                  </div>
                </div>

                <div class="alg_form_group">
                  <label class="alg_form_label">模型文件状态</label>
                  <div class="alg_form_control">
                    {% if absolute_model_dir_exist == 1 %}
                      <span class="sun-state-success">正常</span>
                    {% else %}
                      <span class="sun-state-error">异常</span>
                    {% endif %}
                  </div>
                </div>
                {% endif %}

                <div class="alg_actions">
                  <button type="button" onclick="window.history.go(-1)" class="alg_btn alg_btn_cancel">返回</button>
                  <button type="button" onclick="f_submit()" class="alg_btn alg_btn_submit">提交</button>
                  <span id="top_loading"><img class="top_loading_img" src="/static/images/load.gif" alt="loading">提交中</span>
                  <span id="timer_counter"></span>
                  <span id="submit_msg"></span>
                  <button id="show_log_btn" style="display: none;" onclick="f_log()" type="button" class="alg_btn alg_btn_log">查看详细日志</button>
                </div>
              </div>
              
            </div>
              <!--日志弹窗start -->
              <div id="algorithmSubmitLogDialog" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">

                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                          <h4 class="modal-title" >详细日志</h4>
                      </div>
                      <div class="modal-body">
                        <div style="padding: 5px 20px;">
                            <div id="algorithmSubmitLogData">暂无内容</div>
                        </div>
                      </div>
                    </div>
                  </div>
               </div>
              <!--日志弹窗end -->
          </div>
        </div>
      </div>

    </div>
  </div>
{% endblock content %}

{% block javascripts %}
  {{ block.super }}
<script>
let eleTopLoading = $("#top_loading");
let eleTimerCounter = $("#timer_counter");
let mTimer = null;
let mTimerSpendSecond = 0;//当前计时器开启总时长
    
let handle = "{{ handle }}";
let algorithm_code = "{{ algorithm.code }}";
let algorithm_algorithm_type= "{{ algorithm.algorithm_type }}";

let ele_input_name= $("input[name='name']");
let ele_select_algorithm_type= $("select[name='algorithm_type']");
let ele_input_inference_device= $("input[name='inference_device']");
let ele_textarea_extend_params= $("textarea[name='extend_params']");
let ele_textarea_model_class_names= $("textarea[name='model_class_names']");
let ele_textarea_model_convert_params= $("textarea[name='model_convert_params']");

let ele_select_framework= $("select[name='framework']");
let ele_select_inference= $("select[name='inference']");
let ele_input_model= $("input[name='model']"); //模型文件
let ele_textarea_remark= $("textarea[name='remark']");

let selectedAlgorithmTypeCode = algorithm_algorithm_type;

let curIsPost = false; //当前是否在提交中，已经提交后该变量会设为true，避免重复操作
let ele_submit_msg =$("#submit_msg");

//提交后的日志查看start
let ele_algorithm_submit_log_dialog = $("#algorithmSubmitLogDialog");
let ele_algorithm_submit_log_data = $("#algorithmSubmitLogData");
let ele_algorithm_show_log_btn =$("#show_log_btn");
function f_log() {
    ele_algorithm_submit_log_dialog.modal("toggle");
    //ele_algorithm_submit_log_dialog.modal("show");
    //ele_algorithm_submit_log_dialog.modal("hide");
}
//提交后的日志查看end

ele_select_algorithm_type.change(function () {
    selectedAlgorithmTypeCode = $(this).val();
    f_openAlgorithmTypeAttrs()
});
function f_show_algorithm_type(info) {
    //设置算法框架下拉框
    let html = "<option value=\"0\">请选择</option>";
    let frameworks = info["frameworks"];
    for (let i = 0; i < frameworks.length; i++) {
        let framework = frameworks[i];
       html += "<option value=\""+framework+"\">"+framework+"</option>";

    }
    ele_select_framework.html(html);

    //设置推理引擎下拉框
    html = "<option value=\"0\">请选择</option>";
    let inferences = info["inferences"];
    for (let i = 0; i < inferences.length; i++) {
        let inference = inferences[i];
       html += "<option value=\""+inference+"\">"+inference+"</option>";

    }
    ele_select_inference.html(html);


}
function f_openAlgorithmTypeAttrs() {
    $.ajax({
       url: "/algorithm/openAlgorithmTypeAttrs",
       type: "get",
       async: true,
       data: {
           "algorithm_type_code":selectedAlgorithmTypeCode
       },
       dataType: "json",
       timeout: 0,
       error: function () {
            myToast2025("网络异常，请确定网络正常！","error");
       },
       success: function (res) {
            if(res.code === 1000){
                let info = res.info;
                f_show_algorithm_type(info);
            }else{
                ele_select_framework.html("");
                ele_select_inference.html("");
            }
       }
    });
}

function updateTimer() {
    mTimerSpendSecond++;
    eleTimerCounter.html("耗时"+mTimerSpendSecond.toString()+"秒")
}
function f_startTimer() {
    mTimerSpendSecond = 0;
    if(mTimer){
        clearTimeout(mTimer);
        mTimer = null;
    }
    mTimer = setInterval(updateTimer, 1000);
}
function f_stopTimer() {
    if(mTimer){
        clearTimeout(mTimer);
        mTimer = null;
    }
}

function f_submit() {
    ele_submit_msg.html("");
    ele_submit_msg.hide();

    let name_s = ele_input_name.val().trim();
    if(name_s=== ""){
        myToast2025("请输入算法名称","error");
       return false;
    }
    if(selectedAlgorithmTypeCode==="0" || selectedAlgorithmTypeCode === ""){
        myToast2025("请选择算法类型","error");
       return false;
    }
    let formData = new FormData();
    formData.append('code',algorithm_code);
    formData.append('handle',handle);
    formData.append('name',name_s);
    formData.append('algorithm_type',selectedAlgorithmTypeCode);
    let framework_s = ele_select_framework.val().trim();
    if(framework_s==="0"){
        myToast2025("请选择算法框架","error");
        return false;
    }
    let inference_s = ele_select_inference.val().trim();
    if(inference_s==="0"){
        myToast2025("请选择算法推理引擎","error");
        return false;
    }
    let inference_device_s = ele_input_inference_device.val().trim();
    if(inference_device_s === ""){
        myToast2025("请输入算法推理引擎设备","error");
        return false;
    }
    let extend_params_s = ele_textarea_extend_params.val().trim();
    if(extend_params_s === ""){
        myToast2025("请输入模型推理参数","error");
        return false;
    }
   let model_class_names_s = ele_textarea_model_class_names.val().trim();
    if(model_class_names_s === ""){
        myToast2025("请输入模型目标参数","error");
        return false;
    }

   let model_convert_params_s = ele_textarea_model_convert_params.val().trim();
   if(model_convert_params_s === ""){
        myToast2025("请输入模型转换参数","error");
        return false;
    }

   let remark_s = ele_textarea_remark.val();
    
    let handleUrl;
    formData.append('framework',framework_s);
    formData.append('inference',inference_s);
    formData.append('inference_device',inference_device_s);
    formData.append('extend_params',extend_params_s);
    formData.append('model_class_names',model_class_names_s);
    formData.append('model_convert_params',model_convert_params_s);
    //formData.append('remark',remark_s);

    if(handle === "add"){
        //添加
        handleUrl = "/algorithm/add";
        if(ele_input_model[0].files.length > 0){
            let file = ele_input_model[0].files[0];
            let fs_name = file.name;
            let fs_size = parseInt(file.size);//文件字节大小
            let fs_size_m = parseInt(fs_size / 1024 / 1024); //换算成M单位
            if(inference_s === "TensorRT"){
                if(fs_name.endsWith(".onnx")){
                    //支持
                }else if(fs_name.endsWith(".engine")){
                    //支持
                }else{
                    myToast2025("TensorRT仅支持onnx或engine格式的模型","error");
                    return false;
                }
            }
            else if(inference_s === "OpenVINO"){
                if(!fs_name.endsWith(".tar")){
                    myToast2025("OpenVINO仅支持tar格式的模型","error");
                    return false;
                }
            }
            else if(inference_s === "ONNXRuntime"){
                if(!fs_name.endsWith(".onnx")){
                    myToast2025("ONNXRuntime仅支持onnx格式的模型","error");
                    return false;
                }
            }
            else if(inference_s === "Ascend"){
                if(!fs_name.endsWith(".om")){
                    myToast2025("Ascend仅支持om格式的模型","error");
                    return false;
                }
            }
            else if(inference_s === "RKNPU"){
                if(!fs_name.endsWith(".rknn")){
                    myToast2025("RKNPU仅支持rknn格式的模型","error");
                    return false;
                }
            }
            if(fs_size_m > 1000){
                myToast2025("模型文件不能超过（1000）M："+String(fs_size_m),"error");
                return false;
            }
            formData.append("model",file);
        }else{
           myToast2025("请上传模型文件","error");
           return false;
        }
    }else if(handle === "edit"){
        //编辑
        handleUrl = "/algorithm/edit";
    }else{
        return false;
   }

    if(curIsPost){
        myToast2025("正在提交中，请勿重复提交！","error",500);
        return false;
    }
    curIsPost = true;
    eleTopLoading.show();
    f_startTimer();
    $.ajax({
           url: handleUrl,
           type: "post",
           async: true,
           contentType:false,
           processData:false,
           data: formData,
           dataType: "json",
           timeout: 0,
           error: function () {
               curIsPost = false;
               eleTopLoading.hide();
               f_stopTimer();
               myToast2025("网络异常，请确定网络正常！","error");
           },
           success: function (res) {
               curIsPost = false;
               eleTopLoading.hide();
               f_stopTimer();

               try {
                   let upload_info = res.upload_info;
                    let convert_msg = upload_info["convert_msg"];
                    if(convert_msg !== undefined){
                        let convert_spend = upload_info["convert_spend"]; //模型转换耗时
                        let convert_log = upload_info["convert_log"]; //模型转换日志
                        let upload_info_str = "<p>"+convert_msg +"</p><p>"+convert_spend+"</p><p>"+convert_log+"</p>";
                        ele_algorithm_submit_log_data.html(upload_info_str)
                        ele_algorithm_show_log_btn.show();
                    }
               }catch (e) {
                    console.log(e)
               }
               ele_submit_msg.show();
               ele_submit_msg.html(res.msg)
               if(1000 === res.code){
                   //myToast2025(res.msg,"success");
                   myToast2025(res.msg,"success",1000);
                   setTimeout(function () {
                        window.location.href= "/algorithm/index";
                   }, 1000);
               }else{
                    myToast2025(res.msg,"error");
               }
           }
    });
}

</script>

{% endblock javascripts %}
