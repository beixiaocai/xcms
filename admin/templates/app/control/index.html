{% extends "app/base_site.html" %}

{% block title %} 布控管理 {% endblock title %}

{% block stylesheets %}
  {{ block.super }}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .xc_container {
        color: #333;
        line-height: 1.6;
        margin: 0 auto;
        padding: 10px 20px;
    }

    .xc_toolbar {
        background: white;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .xc_page-title {
        display: flex;
        align-items: center;
        font-size: 16px;
        font-weight: 600;
        color: #1D2129;
        gap: 6px;
        white-space: nowrap;
    }
    
    .xc_page-title i {
        margin-right: 0;
        font-size: 18px;
        color: #165DFF;
    }
    
    .xc_search-input {
        width: 180px;
        min-width: 120px;
        padding: 0 10px;
        font-size: 14px;
        border: 1px solid #E5E6EB;
        border-radius: 6px;
        transition: all 0.2s;
        outline: none;
        height: 36px !important;
        line-height: 36px;
        box-sizing: border-box;
        vertical-align: middle;
        margin-bottom: 5px;
    }
    
    .xc_search-input:focus {
        border-color: #165DFF;
        box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
    }
    
    .xc_search-input::placeholder {
        color: #C9CDD4;
    }
    
    .xc_status-filter {
        padding: 0 28px 0 10px;
        font-size: 14px;
        border: 1px solid #E5E6EB;
        border-radius: 6px;
        transition: all 0.2s;
        background: white;
        color: #4E5969;
        cursor: pointer;
        outline: none;
        min-width: 100px;
        height: 36px !important;
        line-height: 36px;
        box-sizing: border-box;
        vertical-align: middle;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%234E5969" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3cpolyline points="6 9 12 15 18 9"%3e%3c/polyline%3e%3c/svg%3e');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 12px;
        margin-bottom: 5px;
    }
    
    .xc_status-filter:hover {
        border-color: #165DFF;
    }
    
    .xc_btn-modern {
        padding: 0 12px;
        font-size: 14px;
        font-weight: 400;
        border-radius: 6px;
        border: 1px solid #E5E6EB;
        background: #F2F3F5;
        color: #4E5969;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        white-space: nowrap;
        text-decoration: none;
        flex-shrink: 0;
        height: 36px;
        line-height: 1;
        box-sizing: border-box;
        vertical-align: middle;
    }
    
    .xc_btn-modern:hover {
        background: #E5E6EB;
        border-color: #C9CDD4;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .xc_btn-modern.danger {
        color: #F53F3F;
    }
    
    .xc_btn-modern.danger:hover {
        background: #FFECE8;
        border-color: #FFCCC7;
        color: #D03050;
    }
    
    .xc_loading-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #E5E6EB;
        border-top-color: #165DFF;
        border-radius: 50%;
        animation: xc_spin 0.6s linear infinite;
        margin-right: 5px;
    }
    
    @keyframes xc_spin {
        to { transform: rotate(360deg); }
    }
    
    .xc_loading-text {
        color: #6b7280;
        font-size: 12px;
    }

    .xc_table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .xc_table {
        width: 100%;
        border-collapse: collapse;
    }

    .xc_table th {
        background: #fafafa;
        padding: 14px 16px;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }

    .xc_table td {
        padding: 16px;
        font-size: 14px;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: middle;
    }

    .xc_table td:nth-child(4) {
        white-space: nowrap;
    }

    .xc_table tr:hover {
        background: #f9fafb;
    }

    .xc_table tr:last-child td {
        border-bottom: none;
    }

    .xc_id-badge {
        display: inline-block;
        padding: 2px 8px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        font-size: 13px;
        color: #6b7280;
        font-family: monospace;
    }

    .xc_code-text {
        font-size: 14px;
        color: #374151;
        font-weight: 500;
    }

    .xc_stream-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #ecfdf5;
        border-radius: 4px;
        color: #10b981;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
    }

    .xc_stream-link:hover {
        background: #d1fae5;
        text-decoration: none;
    }

    .xc_stream-link.offline {
        background: #f3f4f6;
        color: #6b7280;
    }

    .xc_stream-link.offline:hover {
        background: #e5e7eb;
        text-decoration: none;
    }

    .xc_status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
    }

    .xc_status-badge.controlled {
        background: #dcfce7;
        color: #16a34a;
    }

    .xc_status-badge.not-controlled {
        background: #fef2f2;
        color: #dc2626;
    }

    .xc_fps-text {
        font-size: 13px;
        color: #10b981;
        font-weight: 500;
        margin-left: 8px;
        white-space: nowrap;
    }

    .xc_fps-text.low {
        color: #ef4444;
    }

    .xc_algorithm-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
    }

    .xc_algorithm-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 4px;
        font-size: 13px;
        color: #2563eb;
        cursor: pointer;
        transition: all 0.2s;
    }

    .xc_algorithm-tag:hover {
        background: #dbeafe;
        border-color: #3b82f6;
    }

    .xc_algorithm-tag i {
        font-size: 12px;
    }

    .xc_add-algorithm-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: white;
        border: 1px dashed #d1d5db;
        border-radius: 4px;
        font-size: 13px;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
    }

    .xc_add-algorithm-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        background: #eff6ff;
    }

    .xc_action-btns {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: nowrap;
    }

    .xc_action-btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
    }

    .xc_action-btn:hover {
        background: #f9fafb;
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .xc_action-btn.primary {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    .xc_action-btn.primary:hover {
        background: #059669;
        border-color: #059669;
    }

    .xc_action-btn.danger {
        color: #ef4444;
    }

    .xc_action-btn.danger:hover {
        background: #fef2f2;
        border-color: #ef4444;
    }

    .xc_control-btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
    }

    .xc_control-btn.start {
        background: #3b82f6;
        color: white;
    }

    .xc_control-btn.start:hover {
        background: #2563eb;
    }

    .xc_control-btn.stop {
        background: #10b981;
        color: white;
    }

    .xc_control-btn.stop:hover {
        background: #059669;
    }

    .xc_empty-state {
        text-align: center !important;
        padding: 80px 20px !important;
        color: #9ca3af !important;
    }
    
    .xc_empty-state i {
        font-size: 64px !important;
        color: #d1d5db !important;
        margin-bottom: 16px !important;
        display: block !important;
    }
    
    .xc_empty-state p {
        font-size: 14px !important;
        margin: 0 !important;
    }

    .xc_pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    
    .xc_pagination > .xc_page-btn {
        min-width: 36px;
        height: 36px;
        border-radius: 6px;
        border: 1px solid #ddd;
        background-color: white;
        color: #555;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .xc_pagination > .xc_page-btn:hover:not(.xc_active) {
        border-color: #34495e;
        color: #34495e;
    }
    
    .xc_pagination > .xc_page-btn.xc_active {
        background-color: #34495e;
        color: white;
    }
    
    .xc_pagination > .xc_page-info {
        font-size: 14px;
        color: #7f8c8d;
    }

    .xc_bullet-dialog {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 4px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10001;
        display: none;
        min-width: 160px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }

    .xc_bullet-dialog-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: white;
        border: none;
        text-align: left;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        width: 100%;
    }

    .xc_bullet-dialog-btn:hover {
        background: #f3f4f6;
        color: #1f2937;
    }

    .xc_bullet-dialog-btn i {
        width: 16px;
        text-align: center;
        font-size: 14px;
    }

    .xc_bullet-dialog-btn-danger {
        color: #dc2626 !important;
    }

    .xc_bullet-dialog-btn-danger:hover {
        background: #fef2f2 !important;
        color: #b91c1c !important;
    }

    .xc_modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .xc_modal-overlay.active {
        display: block;
        animation: xc_fadeIn 0.2s ease;
    }

    @keyframes xc_fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .xc_modal-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: xc_slideIn 0.3s ease;
    }

    @keyframes xc_slideIn {
        from {
            transform: translate(-50%, -48%);
            opacity: 0;
        }
        to {
            transform: translate(-50%, -50%);
            opacity: 1;
        }
    }

    .xc_modal-header {
        position: relative;
        padding: 14px 18px;
        border-bottom: 1px solid #e5e7eb;
        background: #fafafa;
        border-radius: 8px 8px 0 0;
    }

    .xc_modal-title {
        font-size: 16px;
        font-weight: 500;
        color: #374151;
    }

    .xc_modal-close {
        position: absolute;
        top: 12px;
        right: 16px;
        width: 30px;
        height: 30px;
        border: none;
        background: white;
        color: #6b7280;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        transition: all 0.2s;
    }

    .xc_modal-close:hover {
        background: #f3f4f6;
        color: #374151;
        border-color: #9ca3af;
    }

    .xc_modal-body {
        flex: 1;
        padding: 18px 20px;
        overflow-y: auto;
    }

    .xc_form-group {
        margin-bottom: 10px;
    }

    .xc_form-label {
        display: block;
        font-size: 14px;
        color: #374151;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .xc_form-label .required {
        color: #ef4444;
        margin-left: 2px;
    }

    .xc_form-input {
        width: 100%;
        padding: 8px 12px;
        font-size: 14px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        color: #374151;
        transition: all 0.2s;
        height: 36px;
    }

    .xc_form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .xc_form-input:disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
    }

    .xc_form-textarea {
        width: 100%;
        padding: 8px 12px;
        font-size: 14px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        color: #374151;
        resize: vertical;
        min-height: 60px;
        transition: all 0.2s;
    }

    .xc_form-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .xc_modal-footer {
        padding: 14px 18px;
        border-top: 1px solid #e5e7eb;
        text-align: right;
        background: #fafafa;
        border-radius: 0 0 8px 8px;
    }

    .xc_modal-btn {
        padding: 8px 20px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        cursor: pointer;
        margin-left: 10px;
        transition: all 0.2s;
        font-weight: 400;
        background: white;
        color: #374151;
    }

    .xc_modal-btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
        color: #374151;
    }

    .xc_modal-btn-primary {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .xc_modal-btn-primary:hover {
        background: #2563eb;
        border-color: #2563eb;
        color: white;
    }

    .right_col {
        background: #f5f7fa !important;
    }

    #algorithmMenu {
        position: fixed;
        top: 0;
        left: 0;
        width: 160px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
        z-index: 9999;
        overflow: hidden;
    }

    .xc_menu_item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        color: #374151;
        border-bottom: 1px solid #f3f4f6;
    }

    .xc_menu_item:last-child {
        border-bottom: none;
    }

    .xc_menu_item:hover {
        background: #f3f4f6;
        color: #1f2937;
    }

    .xc_menu_item i {
        font-size: 14px;
        min-width: 16px;
        text-align: center;
    }

    .xc_menu_danger {
        color: #dc2626 !important;
    }

    .xc_menu_danger:hover {
        background: #fef2f2 !important;
        color: #b91c1c !important;
    }

    .xc_more_menu {
        position: relative;
        display: inline-block;
    }

    .xc_more_dropdown {
        position: fixed;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 140px;
        display: none;
        z-index: 99999;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .xc_more_menu.show .xc_more_dropdown {
        display: block;
    }

    .xc_more_item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border: none;
        background: transparent;
        color: #374151;
        width: 100%;
        text-align: left;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .xc_more_item:hover {
        background: #f3f4f6;
        text-decoration: none;
    }

    .xc_more_item i {
        font-size: 14px;
        color: #6b7280;
    }
</style>
{% endblock stylesheets %}
{% block content %}

  <div class="right_col" role="main">
    <div class="">
      <div class="row">
          <div class="col-md-12 col-sm-12 col-xs-12">
              <div class="x_panel">
   <!-- xc page start -->
    <div class="xc_container">
        <div class="xc_toolbar">
            <div class="xc_page-title">
                <i class="fa fa-cube"></i>
                布控管理
            </div>
            
            <select id="search_status_select" class="xc_status-filter">
                <option value="-1">全部状态</option>
                <option value="1">布控中</option>
                <option value="0">未布控</option>
            </select>
            
            <input type="text" id="search_text_input" class="xc_search-input" placeholder="视频流名称或布控编号"  value="{{ code }}">
            
            <button class="xc_btn-modern" onclick="doSearch()">
                <i class="fa fa-search"></i> 搜索
            </button>
            
            <button class="xc_btn-modern" onclick="openControlModal('add')">
                <i class="fa fa-plus"></i> 添加
            </button>
            
            <div style="position: relative; display: inline-block;">
                <button class="xc_btn-modern" onclick="toggleMoreDialog()">
                    <i class="fa fa-ellipsis-v"></i> 更多
                </button>
                
                <div class="xc_bullet-dialog" id="moreDialog">
                    <button class="xc_bullet-dialog-btn" onclick="f_openHandle('addAll',''); toggleMoreDialog()">
                        <i class="fa fa-play"></i> 全部执行
                    </button>
                    <button class="xc_bullet-dialog-btn" onclick="f_openHandle('cancelAll',''); toggleMoreDialog()">
                        <i class="fa fa-pause"></i> 全部取消
                    </button>
                    <button class="xc_bullet-dialog-btn xc_bullet-dialog-btn-danger" onclick="f_openHandle('deleteAll',''); toggleMoreDialog()">
                        <i class="fa fa-trash"></i> 全部删除
                    </button>
                </div>
            </div>
            
            <div>
                <span id="top_loading" style="display: none; margin-left: 10px;">
                    <span class="xc_loading-spinner"></span>
                    <span class="xc_loading-text">加载中...</span>
                </span>
                <span id="top_msg">{{top_msg}}</span>
            </div>
        </div>

        <div class="xc_table-container">
            <table class="xc_table">
                <thead>
                    <tr>
                        <th width="60">ID</th>
                        <th width="140">布控编号</th>
                        <th width="200">视频流</th>
                        <th width="160">状态</th>
                        <th>选中算法</th>
                        <th width="200">操作</th>
                    </tr>
                </thead>
                <tbody id="data">
                </tbody>
            </table>
        </div>
        
        <div class="xc_pagination" id="pageData">
        </div>
    </div>
   <!-- xc page end -->
              </div>
        </div>
      </div>

      <!--日志弹窗start -->
      <div id="control_log_dialog" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                  <h4 class="modal-title">布控日志</h4>
              </div>
              <div class="modal-body">
                <div style="padding: 5px 20px;">
                  <div class="form-inline" style="margin-bottom: 15px;">
                    <div class="form-group">
                      <label>布控编号：</label>
                      <input type="text" class="xc_form-input" id="log_control_code_input" placeholder="留空查询所有" style="width: 200px; height: 28px;">
                    </div>
                    <button type="button" class="xc_btn-modern" style="height: 28px; padding: 0 8px; font-size: 12px;" onclick="f_searchLog(1)">
                      <i class="fa fa-search"></i> 查询
                    </button>
                    <button type="button" class="xc_btn-modern xc_btn-secondary" style="height: 28px; padding: 0 8px; font-size: 12px;" onclick="f_resetLogSearch()">
                      <i class="fa fa-refresh"></i> 重置
                    </button>
                  </div>
                  <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-bordered">
                      <thead>
                        <tr>
                          <th width="60">ID</th>
                          <th width="150">布控编号</th>
                          <th>日志内容</th>
                          <th width="150">时间</th>
                        </tr>
                      </thead>
                      <tbody id="control_log_data">
                      </tbody>
                    </table>
                  </div>
                  <div class="xc_pagination" id="log_pageData" style="margin-top: 10px;"></div>
                </div>
              </div>
            </div>
          </div>
       </div>
      <!--日志弹窗end -->

       <!--复制弹窗start -->
      <div id="copy_dialog" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                  <h4 class="modal-title" >复制布控</h4>
              </div>
              <div class="modal-body">
                <div style="padding: 5px 20px;">
                  <form class="form-horizontal calender" role="form">
                    <div class="form-group">
                          <label class="col-sm-3 control-label">布控编号</label>
                          <div class="col-sm-9">
                            <input type="text" readonly class="form-control" id="copy_code_input"/>
                          </div>
                    </div>
                   <div class="form-group">
                      <label class="control-label col-md-3 col-sm-3 col-xs-12">视频流</label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                        <select id="copy_streams_select" style="height: 200px;"  class="select2_multiple form-control" required="required"  multiple="multiple" >
                            <option value="0">---请选择视频流(可多选)---</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">备注</label>
                      <div class="col-sm-9">
                        <textarea class="form-control" style="height:40px;" id="copy_remark_textarea"></textarea>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" onclick="f_openCopy()" class="btn btn-default">提交</button>
              </div>
            </div>
          </div>
       </div>
      <!--复制弹窗end -->

      <!--快捷设置弹窗start -->
      <div id="qk_settings_dialog" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                  <h4 class="modal-title" >快捷设置</h4>
              </div>
              <div class="modal-body">
                <div style="padding: 5px 20px;">
                  <form class="form-horizontal calender" role="form">
                   <div class="form-group">
                          <label class="col-sm-3 control-label">布控编号</label>
                          <div class="col-sm-9">
                            <input type="text" readonly class="form-control" id="qk_settings_code"/>
                          </div>
                    </div>
                   <div class="form-group">
                      <label class="col-sm-3 control-label">报警间隔</label>
                      <div class="col-sm-9">
                        <input type="number" class="form-control" id="qk_min_interval"/>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">OSD参数</label>
                      <div class="col-sm-9">
                        <textarea class="form-control" style="height:40px;" id="qk_osd_params"></textarea>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">扩展参数</label>
                      <div class="col-sm-9">
                        <textarea class="form-control" style="height:60px;" id="qk_extend_params"></textarea>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">修改范围</label>
                      <div class="col-sm-9">
                          <select id="qk_modify_range"  class="form-control">
                            <option value="0">当前布控</option>
                            <option value="1">所有布控</option>
                        </select>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" onclick="f_openSettings()" class="btn btn-default">提交</button>
              </div>
            </div>
          </div>
       </div>
      <!--快捷设置弹窗end -->

      <!-- 布控添加/编辑弹窗start -->
      <div class="xc_modal-overlay" id="controlModal">
        <div class="xc_modal-container">
            <div class="xc_modal-header">
                <div class="xc_modal-title" id="modalTitle">添加布控</div>
                <button class="xc_modal-close" onclick="closeControlModal()">×</button>
            </div>
            <div class="xc_modal-body" style="display: flex; gap: 16px;">
                <div class="xc_modal-left" style="flex: 1.4; min-width: 350px;">
                    <div style="width: 100%; background: #000; border-radius: 6px; overflow: hidden;">
                        <div id="video_player" style="background-color: black;aspect-ratio: 16 / 9;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                        <button type="button" onclick="f_clickPlayStart()" class="xc_btn-modern">
                            <i class="fa fa-play"></i> 播放
                        </button>
                        <button type="button" onclick="f_clickPlayStop()" class="xc_btn-modern" style="margin-left: 8px; background: #f3f4f6; color: #6b7280;">
                            <i class="fa fa-stop"></i> 停止
                        </button>
                    </div>
                </div>
                
                <div class="xc_modal-right" style="flex: 0.8; min-width: 280px;">
                <div class="xc_form-group">
                    <label class="xc_form-label">布控编号</label>
                    <input type="text" id="input_code" class="xc_form-input" disabled>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">选择视频流<span class="required">*</span></label>
                    <select id="select_stream" class="xc_form-input" required="required">
                        <option value="0">请选择视频流</option>
                    </select>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">视频信息</label>
                    <input type="text" id="input_video" class="xc_form-input" disabled>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">音频信息</label>
                    <input type="text" id="input_audio" class="xc_form-input" disabled>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">播放地址</label>
                    <input type="text" id="input_video_url" class="xc_form-input" disabled>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">报警音频<span class="required">*</span></label>
                    <select id="select_audio" class="xc_form-input" required="required">
                        <option value="0">请选择报警音频</option>
                    </select>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">报警接口<span class="required">*</span></label>
                    <select id="select_alarm_interface" class="xc_form-input" required="required">
                        <option value="0">请选择报警接口</option>
                    </select>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">报警间隔<span class="required">*</span></label>
                    <input type="number" id="min_interval" class="xc_form-input" value="180">
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">重叠比例<span class="required">*</span></label>
                    <input type="number" id="overlap_thresh" class="xc_form-input" value="0.5" step="0.01">
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">分配进程<span class="required">*</span></label>
                    <input type="number" id="deploy_process_index" class="xc_form-input" value="0" min="0">
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">OSD</label>
                    <textarea id="osd_params" class="xc_form-textarea" rows="2"></textarea>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">扩展参数</label>
                    <textarea id="extend_params" class="xc_form-textarea" rows="2"></textarea>
                </div>

                <div style="height: 15px;"></div>

                </div>
            </div>
            <div class="xc_modal-footer">
                <button class="xc_modal-btn" onclick="closeControlModal()">取消</button>
                <button class="xc_modal-btn xc_modal-btn-primary" onclick="submitControlForm()">
                    <span id="submit_loading" style="display: none;">
                        <span class="xc_loading-spinner"></span>
                    </span>
                    <span id="submit_text">提交</span>
                </button>
            </div>
        </div>
      </div>
      <!-- 布控添加/编辑弹窗end -->

    </div>
  </div>

{% endblock content %}

{% block javascripts %}
  {{ block.super }}

<script src="/static/lib/easyPlayer/js/easyplayer-pro.js?02"></script>
<script>
    let eleTopLoading = $("#top_loading");
    let eleTopMsg= $("#top_msg");
    let eleData = $("#data");
    let elePageData = $("#pageData");
    let eleSearchTextInput= $("#search_text_input");
    let eleSearchStatusSelect= $("#search_status_select");
    
    let eleControlLogDialog = $("#control_log_dialog");
    let eleControlLogData = $("#control_log_data");
    let eleLogControlCodeInput = $("#log_control_code_input");
    let eleLogPageData = $("#log_pageData");
    let curLogPage = 1;
    let curLogPageSize = 10;
    
    let eleCopyDialog = $("#copy_dialog");
    let eleCopyCodeInput = $("#copy_code_input");
    let eleCopyStreamsSelect= $("#copy_streams_select");
    let eleCopyRemarkTextarea= $("#copy_remark_textarea");
    
    let eleQkSettingsDialog = $("#qk_settings_dialog");
    let eleQkSettingsCode = $("#qk_settings_code");
    let eleQkMinInterval = $("#qk_min_interval");
    let eleQkOsdParams = $("#qk_osd_params");
    let eleQkExtendParams = $("#qk_extend_params");
    let eleQkModifyRange = $("#qk_modify_range");
    
    let eleControlModal = $("#controlModal");
    let eleModalTitle = $("#modalTitle");
    let eleInputCode = $("#input_code");
    let eleSelectStream = $("#select_stream");
    let eleInputVideo = $("#input_video");
    let eleInputAudio = $("#input_audio");
    let eleInputVideoUrl = $("#input_video_url");
    let eleVideoPlayer = $("#video_player");

    let eleSelectAudio = $("#select_audio");
    let eleSelectAlarmInterface = $("#select_alarm_interface");
    let eleInputMinInterval = $("#min_interval");
    let eleInputOverlapThresh = $("#overlap_thresh");
    let eleInputDeployProcessIndex = $("#deploy_process_index");
    let eleTextareaOsdParams = $("#osd_params");
    let eleTextareaExtendParams = $("#extend_params");
    let eleSubmitLoading = $("#submit_loading");
    let eleSubmitText = $("#submit_text");
    
    let curPage = 1;
    let curPageSize = 12;
    
    let currentHandle = 'add';
    let currentControlCode = '';
    let mVideoUrl = null;
    let ePlayer = null;
    let streamCodeDict = {};

    let audioCodeDict = {};
    let alarmInterfaceCodeDict = {};
    let streamCode = '';

    let audioCode = '';
    let alarmInterfaceCode = '';
    
    function doSearch() {
        curPage = 1;
        f_openIndex(curPage, curPageSize);
    }
    
    eleSearchTextInput.on('keypress', function(e) {
        if (e.which === 13) {
            doSearch();
        }
    });
    
    eleSearchStatusSelect.on('change', function() {
        doSearch();
    });

    function f_edit(controlCode) {
        openControlModal('edit', controlCode);
    }

    function f_openDel(controlCode) {
        let ret = confirm("确认删除吗？");
        if (ret){
            eleTopLoading.show();
            $.ajax({
                   url: '/control/openDel',
                   type: "post",
                   async: true,
                   data: {"code":controlCode},
                   dataType: "json",
                   timeout: 0,
                   error: function () {
                       eleTopLoading.hide();
                       myToast2025("网络异常，请确定网络正常！","error");
                   },
                   success: function (res) {
                          eleTopLoading.hide();
                          if(1000 === res.code){
                              f_openIndex(curPage,curPageSize);
                          }else{
                               myToast2025(res.msg,"error");
                          }
                   }
                });
        }
    }
    
    function f_openLog(controlCode) {
        eleControlLogDialog.modal("show");
        if (controlCode) {
            eleLogControlCodeInput.val(controlCode);
        } else {
            eleLogControlCodeInput.val("");
        }
        f_searchLog(1);
    }
    
    function f_searchLog(page) {
        curLogPage = page;
        let controlCode = eleLogControlCodeInput.val().trim();
        
        eleTopLoading.show();
        $.ajax({
            url: '/control/openLog',
            type: "get",
            async: true,
            data: {
                "controlCode": controlCode,
                "p": page,
                "ps": curLogPageSize
            },
            dataType: "json",
            timeout: 0,
            error: function () {
                eleTopLoading.hide();
                myToast2025("网络异常，请确定网络正常！","error");
            },
            success: function (res) {
                eleTopLoading.hide();
                if(1000 === res.code){
                    eleControlLogData.html("");
                    let data = res.data;
                    let data_length = data.length;

                    if(0 === data_length){
                        let item_html = "";
                        item_html += "<tr>";
                        item_html += "<td colspan='4' style='text-align:center; color:#999;'>暂无日志</td>";
                        item_html += "</tr>";
                        eleControlLogData.append(item_html);
                    } else {
                        for (let i = 0; i < data_length; i++) {
                            let d = data[i];
                            let item_html = "";
                            item_html += "<tr>";
                            item_html += "<td>" + d["id"] + "</td>";
                            item_html += "<td>" + d["control_code"] + "</td>";
                            item_html += "<td style='word-break: break-all;'>" + d["content"] + "</td>";
                            item_html += "<td>" + d["create_time_str"] + "</td>";
                            item_html += "</tr>";
                            eleControlLogData.append(item_html);
                        }
                    }
                    
                    f_show_logPageData(res.pageData);
                } else {
                    myToast2025(res.msg,"error");
                }
            }
        });
    }
    
    function f_show_logPageData(pageData) {
        let page_size = pageData["page_size"];
        let html = "";
        html += "<div class='xc_page-info'>共" + pageData["page_num"] + "页 / " + pageData["count"] + "条</div>";
        let pageLabels = pageData["pageLabels"];

        for (let i = 0; i < pageLabels.length; i++) {
            let cur = pageLabels[i]["cur"];
            if(cur === 1){
                html += "<div class='xc_page-btn xc_active'>" + pageLabels[i]["name"] + "</div>";
            } else {
                html += "<div class='xc_page-btn' onclick='f_searchLog(" + pageLabels[i]["page"] + ")'>" + pageLabels[i]["name"] + "</div>";
            }
        }
        eleLogPageData.html(html);
    }
    
    function f_resetLogSearch() {
        eleLogControlCodeInput.val("");
        f_searchLog(1);
    }
    
    function f_copy(controlCode) {
        eleTopLoading.show();
        $.ajax({
               url: '/open/getAllStreamData',
               type: "get",
               async: true,
               data: {},
               dataType: "json",
               timeout: 0,
               error: function () {
                   eleTopLoading.hide();
                   myToast2025("网络异常，请确定网络正常！","error");
               },
               success: function (res) {
                   eleTopLoading.hide();
                   if(1000 === res.code){
                       let data = res.data;
                       let html = "<option value=\"0\">---请选择视频流(可多选)---</option>";
                       for (let i = 0; i < data.length; i++) {
                           let d = data[i];
                           let d_code = d["code"];
                           let d_nickname = d["nickname"];
                           html += "<option value=\""+d_code+"\">"+d_nickname+"</option>";
                       }
                       eleCopyDialog.modal("toggle");
                       eleCopyCodeInput.val(controlCode)
                       eleCopyRemarkTextarea.val("copy from "+controlCode)
                       eleCopyStreamsSelect.html(html);
                   }else{
                       myToast2025(res.msg,"error");
                   }
                }
            });
    }
    
    function f_openCopy(controlCode) {
        if (controlCode) {
            eleCopyCodeInput.val(controlCode);
            eleCopyDialog.modal("show");
        } else {
            let val = eleCopyStreamsSelect.val();
            if(val===null){
                myToast2025("请至少选择1个摄像头","error");
                return false;
            }else{
                let vals = [];
                for (let i = 0; i < val.length; i++) {
                    if("0"!==val[i]){
                        vals.push(val[i]);
                    }
                }
                if(vals.length > 0){
                    eleCopyDialog.modal("toggle");

                    let controlCode = eleCopyCodeInput.val()
                    let stream_codes = vals.join(",");
                    let remark = eleCopyRemarkTextarea.val();
                    eleTopLoading.show();
                    $.ajax({
                           url: '/control/openCopy',
                           type: "post",
                           async: true,
                           data: {"controlCode":controlCode,"streamCodes":stream_codes,"remark":remark},
                           dataType: "json",
                           timeout: 0,
                           error: function () {
                               eleTopLoading.hide();
                               myToast2025("网络异常，请确定网络正常！","error");
                           },
                           success: function (res) {
                               eleTopLoading.hide();
                               if(1000 === res.code){
                                   f_openIndex(curPage,curPageSize);
                               }else{
                                    myToast2025(res.msg,"error");
                               }
                           }
                        });
                }else{
                    myToast2025("请至少选择1个摄像头","error");
                    return false;
                }
            }
        }
    }
    
    function f_settings(controlCode) {
        eleTopLoading.show();
        $.ajax({
               url: '/control/openInfo',
               type: "get",
               async: true,
               data: {"code":controlCode},
               dataType: "json",
               timeout: 0,
               error: function () {
                   eleTopLoading.hide();
                   myToast2025("网络异常，请确定网络正常！","error");
               },
               success: function (res) {
                   eleTopLoading.hide();
                   if(1000 === res.code){
                       let min_interval = res.info["min_interval"];
                       let osd_params = res.info["osd_params"];
                       let extend_params = res.info["extend_params"];

                        eleQkSettingsDialog.modal("toggle");
                        eleQkSettingsCode.val(controlCode)
                        eleQkMinInterval.val(min_interval)
                        eleQkOsdParams.val(osd_params)
                        eleQkExtendParams.val(extend_params)
                        eleQkModifyRange.find('option[value="0"]').prop('selected', true);

                   }else{
                        myToast2025(res.msg,"error");
                   }
                }
            });
    }
    
    function f_openSettings() {
        eleQkSettingsDialog.modal("toggle");
        let controlCode = eleQkSettingsCode.val();
        let min_interval = eleQkMinInterval.val();
        let osd_params = eleQkOsdParams.val();
        let extend_params = eleQkExtendParams.val();
        let modify_range = eleQkModifyRange.val()

        eleTopLoading.show();
        $.ajax({
           url: '/control/openSettings',
           type: "post",
           async: true,
           data: {
               "code":controlCode,
               "min_interval":min_interval,
               "osd_params":osd_params,
               "extend_params":extend_params,
               "modify_range":modify_range
           },
           dataType: "json",
           timeout: 0,
           error: function () {
               eleTopLoading.hide();
               myToast2025("网络异常，请确定网络正常！","error");
           },
           success: function (res) {
               eleTopLoading.hide();
               if(1000 === res.code){
               }else{
                    myToast2025(res.msg,"error");
               }
           }
        });
    }
    
    function f_open_player(stream_app, stream_name){
        window.open("/stream/player?app="+stream_app+"&name="+stream_name);
    }

    function f_toggle_more_menu(button, stream_app, stream_name) {
        document.querySelectorAll('.xc_more_menu').forEach(menu => {
            if (menu !== button.parentElement) {
                menu.classList.remove('show');
            }
        });
        
        const menu = button.parentElement;
        const dropdown = menu.querySelector('.xc_more_dropdown');
        const rect = button.getBoundingClientRect();
        
        const isShowing = menu.classList.contains('show');
        
        document.querySelectorAll('.xc_more_menu').forEach(m => m.classList.remove('show'));
        
        if (!isShowing) {
            menu.classList.add('show');
            
            let top = rect.bottom + 4;
            let left = rect.right - 140;
            
            dropdown.style.top = top + 'px';
            dropdown.style.left = left + 'px';
            
            requestAnimationFrame(() => {
                const dropdownRect = dropdown.getBoundingClientRect();
                
                if (dropdownRect.bottom > window.innerHeight) {
                    top = rect.top - dropdownRect.height - 4;
                    dropdown.style.top = top + 'px';
                }
                
                if (dropdownRect.left < 0) {
                    left = 4;
                    dropdown.style.left = left + 'px';
                }
            });
        }
        
        document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeMenu);
            }
        });
    }

    function toggleMoreDialog() {
        const bulletDialog = document.getElementById('moreDialog');
        if (bulletDialog.style.display === 'block') {
            bulletDialog.style.display = 'none';
        } else {
            bulletDialog.style.display = 'block';
        }
    }

    document.addEventListener('click', function(event) {
        const moreButton = event.target.closest('button[onclick="toggleMoreDialog()"]');
        const bulletDialog = document.getElementById('moreDialog');
        
        if (!moreButton && !bulletDialog.contains(event.target)) {
            bulletDialog.style.display = 'none';
        }
    });
    
    function f_open_flow(code) {
        let url = "/algorithmFlow/index?search="+code;
        window.open(url);
    }
    
    function f_show_pageData(pageData) {
        let page_size = pageData["page_size"];
        let html = "";
        html+="<div class=\"xc_page-info\">共"+pageData["page_num"]+"页 / "+pageData["count"]+"条</div>";
        let pageLabels = pageData["pageLabels"];

        for (let i = 0; i < pageLabels.length; i++) {
            let cur = pageLabels[i]["cur"];
            if(cur === 1){
                html+="<div class=\"xc_page-btn xc_active\">"+pageLabels[i]["name"]+"</div>";
            }else{
                html+="<div class=\"xc_page-btn\" onclick=\"f_openIndex("+pageLabels[i]["page"]+","+page_size+")\" >"+pageLabels[i]["name"]+"</div>";
            }
        }
        elePageData.html(html);
    }
    
    function f_openIndex(page,page_size) {
        curPage = page;
        curPageSize = page_size;
        let search_text = eleSearchTextInput.val().trim();
        let search_status = eleSearchStatusSelect.val();
        eleTopLoading.show();
        $.ajax({
               url: '/control/openIndex',
               type: "get",
               async: true,
               data: {"p":page,"ps":page_size,"search_text":search_text,"search_status":search_status},
               dataType: "json",
               timeout: 0,
               error: function () {
                   eleTopLoading.hide();
                   myToast2025("网络异常，请确定网络正常！","error");
               },
               success: function (res) {
                   eleTopLoading.hide();
                   if(res.code === 1000)
                   {
                       let data = res.data;

                       if(data.length === 0){
                            eleData.html("<tr><td colspan='6' class='xc_empty-state'><i class='fa fa-video-camera'></i><p>暂无数据</p></td></tr>");
                            f_show_pageData(res.pageData)
                       }else{
                            eleData.html("");
                            
                            for(let i=0;i<data.length;i++){
                                let control = data[i];
                                let stream_nickname = control["stream_nickname"] || (control["stream_app"] + "_" + control["stream_name"]);
                                let isOnline = control["stream_active"] === 1 || control["stream_active"] === "1";
                                let isControlled = control["cur_state"] === 1 || control["cur_state"] === "1";
                                let controlId = control["id"] || "";
                                
                                let statusBadge = isControlled 
                                    ? '<span class="xc_status-badge controlled"><i class="fa fa-check-circle"></i> 布控中</span>'
                                    : '<span class="xc_status-badge not-controlled"><i class="fa fa-times-circle"></i> 未布控</span>';
                                
                                let streamLink = isOnline
                                    ? '<a class="xc_stream-link" href="javascript:f_open_player(\''+control["stream_app"]+'\',\''+control["stream_name"]+'\')"><i class="fa fa-eye"></i> '+stream_nickname+'</a>'
                                    : '<a class="xc_stream-link offline" href="javascript:f_open_player(\''+control["stream_app"]+'\',\''+control["stream_name"]+'\')">'+stream_nickname+'</a>';
                                
                                let checkFps = control["checkFps"] || "0.00";
                                let fpsHtml = "";
                                if(isControlled){
                                    let fpsValue = parseFloat(checkFps);
                                    let fpsClass = fpsValue > 0 ? '' : ' low';
                                    fpsHtml = '<span class="xc_fps-text'+fpsClass+'">'+checkFps+' fps</span>';
                                }
                                
                                let algorithmsHtml = '<div class="xc_algorithm-tags">';
                                algorithmsHtml += '<span class="xc_add-algorithm-btn" onclick="f_add_algorithm_redirect(\''+control["code"]+'\')"><i class="fa fa-plus"></i> 添加</span>';
                                
                                if(control['algorithms'] && control['algorithms'].length > 0){
                                    for(let j=0;j<control['algorithms'].length;j++){
                                        let algorithm = control['algorithms'][j];
                                        let algorithmName = algorithm["flow_name"];
                                        algorithmsHtml += '<span class="xc_algorithm-tag" onclick="f_open_algorithm_menu(\''+algorithm["code"]+'\',\''+algorithm["flow_code"]+'\',\''+algorithmName+'\',event)"><i class="fa fa-code"></i> '+algorithmName+'</span>';
                                    }
                                }
                                algorithmsHtml += '</div>';
                                
                                let controlBtn = isControlled 
                                    ? '<button class="xc_control-btn stop" onclick="f_openHandle(\'cancel\',\''+control["code"]+'\')"><i class="fa fa-stop"></i> 取消</button>'
                                    : '<button class="xc_control-btn start" onclick="f_openHandle(\'add\',\''+control["code"]+'\')"><i class="fa fa-play"></i> 执行</button>';
                                
                                let actionBtns = '<div class="xc_action-btns">';
                                actionBtns += controlBtn;
                                actionBtns += '<button class="xc_action-btn" onclick="f_open_player(\''+control["push_stream_app"]+'\',\''+control["push_stream_name"]+'\')">算法流</button>';
                                
                                actionBtns += '<div class="xc_more_menu">';
                                actionBtns += '<button class="xc_action-btn" onclick="f_toggle_more_menu(this)"><i class="fa fa-ellipsis-v"></i></button>';
                                actionBtns += '<div class="xc_more_dropdown">';
                                actionBtns += '<a class="xc_more_item" href="javascript:f_settings(\''+control["code"]+'\')"><i class="fa fa-cog"></i> 快捷设置</a>';
                                actionBtns += '<a class="xc_more_item" href="javascript:f_edit(\''+control["code"]+'\')"><i class="fa fa-pencil"></i> 编辑</a>';
                                actionBtns += '<a class="xc_more_item" href="javascript:f_copy(\''+control["code"]+'\')"><i class="fa fa-copy"></i> 复制</a>';
                                actionBtns += '<a class="xc_more_item" href="javascript:f_openLog(\''+control["code"]+'\')"><i class="fa fa-file-text-o"></i> 日志</a>';
                                actionBtns += '<a class="xc_more_item xc_menu_danger" href="javascript:f_openDel(\''+control["code"]+'\')"><i class="fa fa-trash"></i> 删除</a>';
                                actionBtns += '</div></div>';
                                
                                actionBtns += '</div>';
                                
                                let item_html = "<tr>";
                                item_html += "<td><span class='xc_id-badge'>" + controlId + "</span></td>";
                                item_html += "<td><span class='xc_code-text'>" + control["code"] + "</span></td>";
                                item_html += "<td>" + streamLink + "</td>";
                                item_html += "<td>" + statusBadge + fpsHtml + "</td>";
                                item_html += "<td>" + algorithmsHtml + "</td>";
                                item_html += "<td>" + actionBtns + "</td>";
                                item_html += "</tr>";

                                eleData.append(item_html);
                           }
                            f_show_pageData(res.pageData)
                       }

                   }
                   else
                   {
                       eleData.html("<tr><td colspan='6' class='xc_empty-state'><i class='fa fa-exclamation-triangle'></i><p>"+res.msg+"</p></td></tr>");
                       f_show_pageData(res.pageData);
                   }
               }
            });
    }

    function f_openHandle(handle,controlCode) {
        if(handle === "addAll"){
            let ret = confirm("确认全部执行吗？");
            if (!ret) return false;
        }else if(handle === "cancelAll"){
            let ret = confirm("确认全部取消吗？");
            if (!ret) return false;
        }else if(handle === "deleteAll"){
            let ret = confirm("确认全部删除吗？");
            if (!ret) return false;
        }

        eleTopLoading.show();
        $.ajax({
           url: '/control/openHandle',
           type: "post",
           async: true,
           data: {"handle":handle,"code":controlCode,"state":10},
           dataType: "json",
           timeout: 0,
           error: function () {
                eleTopLoading.hide();
                myToast2025("网络异常，请确定网络正常！","error");
           },
           success: function (res) {
                eleTopLoading.hide();

                if(1000 === res.code){
                    myToast2025(res.msg,"success",1000);
                    setTimeout(function () {
                        f_openIndex(curPage,curPageSize);
                    }, 1000);
               }else{
                    myToast2025(res.msg,"error");
               }
           }
        });

    }
    
    function f_reload() {
        f_openIndex(curPage,curPageSize);
    }
    
    function f_search(name) {
        eleSearchTextInput.val(name);
        curPage = 1;
        f_openIndex(curPage,curPageSize);
    }
    
    eleSearchTextInput.on("keydown",function(e){
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            doSearch();
        }
    })
    
    window.onload = function (){
        f_openIndex(curPage,curPageSize);
    };
    
    let currentAlgorithmCode = '';
    let currentFlowCode = '';
    let currentAlgorithmName = '';
    
    function f_open_algorithm_menu(code, flow_code, algorithm_name, event) {
        currentAlgorithmCode = code;
        currentFlowCode = flow_code;
        currentAlgorithmName = algorithm_name;
        
        event.stopPropagation();
        
        const target = event.currentTarget;
        const rect = target.getBoundingClientRect();
        
        const menu = document.getElementById('algorithmMenu');
        menu.style.left = `${rect.left + rect.width / 2 - 60}px`;
        menu.style.top = `${rect.bottom + 5}px`;
        
        menu.style.display = 'block';
        
        document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target) && e.target !== target) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            }
        });
    }
    
    function f_close_algorithm_menu() {
        document.getElementById('algorithmMenu').style.display = 'none';
    }
    
    function f_view_algorithm() {
        f_open_flow(currentFlowCode);
        f_close_algorithm_menu();
    }
    
    function f_edit_algorithm() {
        f_close_algorithm_menu();
        
        const modal = document.getElementById('algorithmModal');
        const iframe = document.getElementById('algorithmIframe');
        const modalTitle = document.getElementById('algorithmModalTitle');
        
        modalTitle.textContent = '编辑布控算法';
        iframe.src = '/controlAlgorithm/edit?code=' + encodeURIComponent(currentAlgorithmCode);
        modal.classList.add('active');
    }
    
    function f_delete_algorithm() {
        f_close_algorithm_menu();
        
        if (confirm('确定要删除布控算法 "' + currentAlgorithmName + '" 吗？')) {
            $.ajax({
                url: '/controlAlgorithm/openDel',
                type: 'POST',
                data: {
                    code: currentAlgorithmCode
                },
                dataType: 'json',
                success: function(res) {
                    if (res.code === 1000) {
                        myToast2025('删除成功', 'success');
                        f_openIndex(curPage, curPageSize);
                    } else {
                        myToast2025(res.msg, 'error');
                    }
                },
                error: function() {
                    myToast2025('网络异常，请稍后重试', 'error');
                }
            });
        }
    }
    
    function openControlModal(handle, code) {
        currentHandle = handle;
        currentControlCode = code || '';
        
        if(handle === 'add'){
            eleModalTitle.text('添加布控');
        resetControlForm();
            loadAddParams();
        }else if(handle === 'edit'){
            eleModalTitle.text('编辑布控');
            resetControlForm();
            loadEditParams(code);
        }
        
        eleControlModal.addClass('active');
    }
    
    function closeControlModal() {
        eleControlModal.removeClass('active');
        if(ePlayer){
            f_playStop();
        }
    }
    
    $('#controlModal').click(function(e) {
        if (e.target === this) {
            closeControlModal();
        }
    });
    
    $(document).keydown(function(e) {
        if (e.keyCode === 27 && $('#controlModal').hasClass('active')) {
            closeControlModal();
        }
    });
    
    function resetControlForm() {
        eleInputCode.val('');
        eleSelectStream.val('0');
        eleSelectStream.prop('disabled', false);
        eleInputVideo.val('');
        eleInputAudio.val('');
        eleInputVideoUrl.val('');
        eleSelectAudio.val('0');
        eleSelectAlarmInterface.val('0');
        eleInputMinInterval.val('');
        eleInputOverlapThresh.val('');
        eleInputDeployProcessIndex.val('');
        eleTextareaOsdParams.val('');
        eleTextareaExtendParams.val('');
        mVideoUrl = null;
        if(ePlayer){
            ePlayer.destroy();
            ePlayer = null;
        }
    }
    
    function loadAddParams() {
        $.ajax({
            url: '/control/openAddContext',
            type: 'get',
            async: true,
            data: {},
            dataType: 'json',
            timeout: 0,
            error: function() {
                myToast2025("加载参数失败，请稍后重试","error");
            },
            success: function(res) {
                if(res.code === 1000){
                    let context = res.context;
                    
                    if(context.control && context.control.code){
                        eleInputCode.val(context.control.code);
                    }
                    
                    if(context.control){
                        if(context.control.min_interval !== undefined){
                            eleInputMinInterval.val(context.control.min_interval);
                        }
                        if(context.control.overlap_thresh !== undefined){
                            eleInputOverlapThresh.val(context.control.overlap_thresh);
                        }
                        if(context.control.deploy_process_index !== undefined){
                            eleInputDeployProcessIndex.val(context.control.deploy_process_index);
                        }
                    }
                    
                    let streamHtml = "<option value=\"0\">请选择视频流</option>";
                    if(context.streams && context.streams.length > 0){
                        for(let i = 0; i < context.streams.length; i++){
                            let stream = context.streams[i];
                            streamCodeDict[stream.code] = {
                                'code':stream.code,
                                "app":stream.app,
                                "name":stream.name,
                                "video":stream.video,
                                "video_codec_name":stream.video_codec_name,
                                "video_width":parseInt(stream.video_width),
                                "video_height":parseInt(stream.video_height),
                                "audio":stream.audio,
                                "videoUrl":stream.videoUrl,
                                "wsHost":stream.wsHost,
                                "wsMp4Url":stream.wsMp4Url,
                                "nickname":stream.nickname
                            };
                            streamHtml += "<option value=\""+stream.code+"\">"+stream.nickname+"</option>";
                        }
                    }
                    eleSelectStream.html(streamHtml);
                    
                    let audioHtml = "<option value=\"0\">请选择报警音频</option>";
                    if(context.audios && context.audios.length > 0){
                        for(let i = 0; i < context.audios.length; i++){
                            let audio = context.audios[i];
                            audioCodeDict[audio.code] = {
                                "code":audio.code,
                                "name":audio.name
                            };
                            audioHtml += "<option value=\""+audio.code+"\">"+audio.name+"</option>";
                        }
                    }
                    eleSelectAudio.html(audioHtml);
                    
                    let alarmHtml = "<option value=\"0\">请选择报警接口</option>";
                    if(context.alarmInterfaces && context.alarmInterfaces.length > 0){
                        for(let i = 0; i < context.alarmInterfaces.length; i++){
                            let alarm = context.alarmInterfaces[i];
                            alarmInterfaceCodeDict[alarm.code] = {
                                "code":alarm.code,
                                "name":alarm.name
                            };
                            alarmHtml += "<option value=\""+alarm.code+"\">"+alarm.name+"</option>";
                        }
                    }
                    eleSelectAlarmInterface.html(alarmHtml);
                }else{
                    myToast2025(res.msg,"error");
                }
            }
        });
    }
    
    function loadEditParams(code) {
        $.ajax({
            url: '/control/openEditContext',
            type: 'get',
            async: true,
            data: {"code":code},
            dataType: 'json',
            timeout: 0,
            error: function() {
                myToast2025("加载参数失败，请稍后重试","error");
            },
            success: function(res) {
                if(res.code === 1000){
                    let context = res.context;
                    let control = context.control;
                    let control_stream = context.control_stream;
                    
                    eleInputCode.val(control.code);
                    
                    let streamHtml = "<option value=\"0\">请选择视频流</option>";
                    if(control_stream){
                        streamCodeDict[control_stream.code] = {
                            'code':control_stream.code,
                            "app":control_stream.app,
                            "name":control_stream.name,
                            "video":control_stream.video,
                            "video_codec_name":control_stream.video_codec_name,
                            "video_width":parseInt(control_stream.video_width),
                            "video_height":parseInt(control_stream.video_height),
                            "audio":control_stream.audio,
                            "videoUrl":control_stream.videoUrl,
                            "wsHost":control_stream.wsHost,
                            "wsMp4Url":control_stream.wsMp4Url,
                            "nickname":control_stream.nickname
                        };
                        streamHtml += "<option value=\""+control_stream.code+"\">"+control_stream.nickname+"</option>";
                    }
                    
                    eleSelectStream.html(streamHtml);
                    eleSelectStream.val(control_stream.code);
                    eleSelectStream.prop('disabled', true);
                    
                    let audioHtml = "<option value=\"0\">请选择报警音频</option>";
                    if(context.audios && context.audios.length > 0){
                        for(let i = 0; i < context.audios.length; i++){
                            let audio = context.audios[i];
                            audioCodeDict[audio.code] = {
                                "code":audio.code,
                                "name":audio.name
                            };
                            audioHtml += "<option value=\""+audio.code+"\">"+audio.name+"</option>";
                        }
                    }
                    eleSelectAudio.html(audioHtml);
                    
                    let alarmHtml = "<option value=\"0\">请选择报警接口</option>";
                    if(context.alarmInterfaces && context.alarmInterfaces.length > 0){
                        for(let i = 0; i < context.alarmInterfaces.length; i++){
                            let alarm = context.alarmInterfaces[i];
                            alarmInterfaceCodeDict[alarm.code] = {
                                "code":alarm.code,
                                "name":alarm.name
                            };
                            alarmHtml += "<option value=\""+alarm.code+"\">"+alarm.name+"</option>";
                        }
                    }
                    eleSelectAlarmInterface.html(alarmHtml);

                    eleSelectAudio.val(control.audio_code);
                    eleSelectAlarmInterface.val(control.alarm_interface_code);
                    eleInputMinInterval.val(control.min_interval);
                    eleInputOverlapThresh.val(control.overlap_thresh);
                    eleInputDeployProcessIndex.val(control.deploy_process_index);
                    eleTextareaOsdParams.val(control.osd_params);
                    eleTextareaExtendParams.val(control.extend_params);
                    
                    if(control_stream){
                        eleInputVideoUrl.val(control_stream.wsMp4Url);
                        eleInputVideo.val(control_stream.video);
                        eleInputAudio.val(control_stream.audio);
                        mVideoUrl = control_stream.wsMp4Url;
                        
                        setTimeout(function() {
                            if(mVideoUrl){
                                f_playStart(mVideoUrl);
                            }
                        }, 300);
                    }
                }else{
                    myToast2025(res.msg,"error");
                }
            }
        });
    }
    
    eleSelectStream.change(function () {
        streamCode = $(this).val();
        let stream = streamCodeDict[streamCode];
        if (stream) {
            let wsMp4Url = stream["wsMp4Url"];
            let video_url = wsMp4Url;

            mVideoUrl = video_url;

            eleInputVideoUrl.val(video_url);
            eleInputVideo.val(stream["video"]);
            eleInputAudio.val(stream["audio"]);
            
            if(ePlayer){
                f_playStop();
            }
            
            setTimeout(function() {
                if(mVideoUrl){
                    f_playStart(mVideoUrl);
                }
            }, 300);
        }else{
            eleInputVideoUrl.val("");
            eleInputVideo.val("");
            eleInputAudio.val("");
            mVideoUrl = null;
            
            if(ePlayer){
                f_playStop();
            }
        }
    });
    
    function f_createEPlayer() {
        ePlayer = new EasyPlayerPro({
            container: eleVideoPlayer.get(0),
            videoBuffer: 0.1,
            videoBufferDelay: Number(3),
            decoder: '/static/lib/easyPlayer/js/decoder-pro.js',
            isResize: true,
            text: "布控预览",
            loadingText: "加载中",
            debug: false,
            debugLevel: "debug",
            useMSE: true,
            useSIMD: false,
            useWCS: true,
            hasAudio: true,
            websocket1006ErrorReplay: true,
            networkDelayTimeoutReplay: true,
            useMThreading: true,
            showBandwidth: false,
            showPerformance: false,
            operateBtns: {
                fullscreen: false,
                screenshot: false,
                play: true,
                audio: false,
                ptz: false,
                quality: false,
                performance: false,
            },
            background: "/static/images/player_poster.jpg",
            timeout: 10,
            qualityConfig: ['普清', '高清', '超清'],
            forceNoOffscreen: true,
            isNotMute: false,
            heartTimeout: Number(7),
            ptzClickType: 'mouseDownAndUp',
            ptzZoomShow: true,
            ptzMoreArrowShow: true,
            ptzApertureShow: true,
            ptzFocusShow: true,
            pauseAndNextPlayUseLastFrameShow: true,
            heartTimeoutReplayUseLastFrameShow: true,
            replayUseLastFrameShow: true,
            fullscreenWatermarkConfig: {
                text: "",
            }
        });
    }
    
    function f_playStart(video_url){
        if(video_url === "" || typeof video_url === "undefined"){
            myToast2025("请输入播放地址（支持ws-fmp4/http-fmp4）！","error");
            return false;
        }
        if(video_url.startsWith("ws://") || video_url.startsWith("http://")){
            if (ePlayer) {
                ePlayer.destroy().then(() => {
                    f_createEPlayer();
                    ePlayer.play(video_url);
                });
            } else {
                f_createEPlayer();
                ePlayer.play(video_url);
            }
        }else{
             myToast2025("视频流地址格式不正确！","error");
             return false;
        }
    }
    
    function f_playStop(){
        if(ePlayer){
            ePlayer.destroy();
            ePlayer = null;
        }
    }
    
    function f_clickPlayStart() {
        if(mVideoUrl){
            f_playStart(mVideoUrl);
        }
    }
    
    function f_clickPlayStop() {
        f_playStop();
    }
    
    function submitControlForm() {
        streamCode = eleSelectStream.val().trim();
        if(streamCode==="0"){
            myToast2025("请选择视频流","error");
            return;
        }

        audioCode = eleSelectAudio.val().trim();
        if(audioCode==="0"){
            myToast2025("请选择音频","error");
            return;
        }

        alarmInterfaceCode = eleSelectAlarmInterface.val().trim();
        if(alarmInterfaceCode==="0"){
            myToast2025("请选择报警接口","error");
            return;
        }

        let minInterval = parseInt(eleInputMinInterval.val());
        if(isNaN(minInterval)){
            myToast2025("报警间隔时间不能为空","error");
            return;
        }
        if(minInterval<0){
            myToast2025("报警间隔时间不能小于0秒","error");
            return;
        }

        let overlapThresh = parseFloat(eleInputOverlapThresh.val());
        if(isNaN(overlapThresh)){
            myToast2025("重叠阈值不能为空","error");
            return;
        }

        if(overlapThresh<=0){
            myToast2025("重叠阈值不能小于等于0","error");
            return;
        }
        if(overlapThresh>1){
            myToast2025("重叠阈值不能大于1","error");
            return;
        }

        let deployProcessIndex = parseInt(eleInputDeployProcessIndex.val()) || 0;

        let osd_params = eleTextareaOsdParams.val().trim();
        let extend_params = eleTextareaExtendParams.val().trim();

        let polygon = "0,0,0,1,1,1,1,0";
        let polygon_type = 1;

        let data = {
            "controlCode":currentHandle === 'add' ? eleInputCode.val() : currentControlCode,
            "audioCode":audioCode,
            "alarmInterfaceCode":alarmInterfaceCode,
            "polygon":polygon,
            "polygon_type": polygon_type,
            "minInterval":minInterval,
            "overlapThresh":overlapThresh,
            "deployProcessIndex":deployProcessIndex,
            "osd_params":osd_params,
            "extend_params":extend_params
        };

        let handleUrl;
        if(currentHandle === 'add'){
            handleUrl = "/control/openAdd";
            let stream = streamCodeDict[streamCode];
            if (stream){
                data["streamApp"] = stream["app"];
                data["streamName"] = stream["name"];
                data["streamVideo"] = stream["video"];
                data["streamAudio"] = stream["audio"];
            }else{
                return;
            }
        }else if(currentHandle === 'edit'){
            handleUrl = "/control/openEdit";
        }else{
            return;
        }

        eleSubmitLoading.show();
        eleSubmitText.text('提交中...');

        $.ajax({
           url: handleUrl,
           type: "post",
           async: true,
           data: data,
           dataType: "json",
           timeout: 0,
           error: function () {
                eleSubmitLoading.hide();
                eleSubmitText.text('提交');
                myToast2025("网络异常，请确定网络正常！","error");
           },
           success: function (res) {
                eleSubmitLoading.hide();
                eleSubmitText.text('提交');

                if(1000 === res.code){
                    myToast2025(res.msg,"success");
                    setTimeout(function() {
                        closeControlModal();
                        f_openIndex(curPage,curPageSize);
                    }, 1000);
                }else{
                    myToast2025(res.msg,"error");
                }
           }
        });
    }
    
    function f_add_algorithm_redirect(controlCode) {
        const modal = document.getElementById('algorithmModal');
        const iframe = document.getElementById('algorithmIframe');
        const modalTitle = document.getElementById('algorithmModalTitle');
        
        modalTitle.textContent = '添加布控算法';
        iframe.src = '/controlAlgorithm/add?controlCode=' + encodeURIComponent(controlCode);
        modal.classList.add('active');
    }
    
    function closeAlgorithmModal() {
        const modal = document.getElementById('algorithmModal');
        const iframe = document.getElementById('algorithmIframe');
        
        iframe.src = '';
        modal.classList.remove('active');
        f_openIndex(curPage, curPageSize);
    }
</script>

<div id="algorithmMenu">
    <div class="xc_menu_item" onclick="f_view_algorithm()"><i class="fa fa-eye"></i> 查看业务算法</div>
    <div class="xc_menu_item" onclick="f_edit_algorithm()"><i class="fa fa-pencil"></i> 编辑布控算法</div>
    <div class="xc_menu_item xc_menu_danger" onclick="f_delete_algorithm()"><i class="fa fa-trash"></i> 删除布控算法</div>
</div>

<div class="xc_modal-overlay" id="algorithmModal">
    <div class="xc_modal-container" style="max-width: 900px; max-height: 90vh;">
        <div class="xc_modal-header">
            <div class="xc_modal-title" id="algorithmModalTitle">添加布控算法</div>
            <button class="xc_modal-close" onclick="closeAlgorithmModal()">×</button>
        </div>
        <div class="xc_modal-body" style="padding: 0; overflow: hidden; flex: 1;">
            <iframe id="algorithmIframe" style="width: 100%; height: 100%; border: none; min-height: 600px;"></iframe>
        </div>
    </div>
</div>
{% endblock javascripts %}
