{% extends "app/base_site.html" %}

{% block title %} 计划任务 {% endblock title %}

{% block stylesheets %}
  {{ block.super }}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .xc_container {
        color: #333;
        line-height: 1.6;
        margin: 0 auto;
        padding: 10px 20px;
    }

    .xc_toolbar {
        background: white;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .xc_page-title {
        display: flex;
        align-items: center;
        font-size: 16px;
        font-weight: 600;
        color: #1D2129;
        gap: 6px;
        white-space: nowrap;
    }
    
    .xc_page-title i {
        margin-right: 0;
        font-size: 18px;
        color: #165DFF;
    }
    
    .xc_search-input {
        width: 180px;
        min-width: 120px;
        padding: 0 10px;
        font-size: 13px;
        border: 1px solid #E5E6EB;
        border-radius: 6px;
        transition: all 0.2s;
        outline: none;
        height: 32px !important;
        line-height: 32px;
        box-sizing: border-box;
        vertical-align: middle;
        margin-bottom: 5px;
    }
    
    .xc_search-input:focus {
        border-color: #165DFF;
        box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
    }
    
    .xc_search-input::placeholder {
        color: #C9CDD4;
    }
    
    .xc_status-filter {
        padding: 0 28px 0 10px;
        font-size: 13px;
        border: 1px solid #E5E6EB;
        border-radius: 6px;
        transition: all 0.2s;
        background: white;
        color: #4E5969;
        cursor: pointer;
        outline: none;
        min-width: 100px;
        height: 32px !important;
        line-height: 32px;
        box-sizing: border-box;
        vertical-align: middle;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%234E5969" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3cpolyline points="6 9 12 15 18 9"%3e%3c/polyline%3e%3c/svg%3e');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 12px;
        margin-bottom: 5px;
    }
    
    .xc_status-filter:hover {
        border-color: #165DFF;
    }
    
    .xc_btn-modern {
        padding: 0 10px;
        font-size: 13px;
        font-weight: 400;
        border-radius: 6px;
        border: 1px solid #E5E6EB;
        background: #F2F3F5;
        color: #4E5969;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        white-space: nowrap;
        text-decoration: none;
        flex-shrink: 0;
        height: 32px;
        line-height: 1;
        box-sizing: border-box;
        vertical-align: middle;
    }
    
    .xc_btn-modern:hover {
        background: #E5E6EB;
        border-color: #C9CDD4;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .xc_btn-modern:active {
        transform: translateY(0);
    }
    
    .xc_btn-modern.danger {
        color: #F53F3F;
    }
    
    .xc_btn-modern.danger:hover {
        background: #FFECE8;
        border-color: #FFCCC7;
        color: #D03050;
    }

    .xc_btn-modern.success {
        color: #10b981;
    }
    
    .xc_btn-modern.success:hover {
        background: #ecfdf5;
        border-color: #10b981;
    }
    
    .xc_loading-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #E5E6EB;
        border-top-color: #165DFF;
        border-radius: 50%;
        animation: xc_spin 0.6s linear infinite;
        margin-right: 5px;
    }
    
    @keyframes xc_spin {
        to { transform: rotate(360deg); }
    }
    
    .xc_loading-text {
        color: #6b7280;
        font-size: 12px;
    }

    .xc_empty-state {
        text-align: center !important;
        padding: 80px 20px !important;
        color: #9ca3af !important;
        display: block !important;
    }
    
    .xc_empty-state i {
        font-size: 64px !important;
        color: #d1d5db !important;
        margin-bottom: 16px !important;
        display: block !important;
    }
    
    .xc_empty-state p {
        font-size: 14px !important;
        margin: 0 !important;
        display: block !important;
    }

    td.xc_empty-state {
        text-align: center !important;
        display: table-cell !important;
    }

    .xc_table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .xc_table {
        width: 100%;
        border-collapse: collapse;
    }

    .xc_table th {
        background: #fafafa;
        padding: 12px 16px;
        text-align: left;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
    }

    .xc_table td {
        padding: 12px 16px;
        font-size: 13px;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
    }

    .xc_table tr:hover {
        background: #f9fafb;
    }

    .xc_table tr:last-child td {
        border-bottom: none;
    }

    .xc_status-badge {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
    }

    .xc_status-badge.enabled {
        background: #ecfdf5;
        color: #10b981;
    }

    .xc_status-badge.disabled {
        background: #fef2f2;
        color: #ef4444;
    }

    .xc_action-btns {
        display: flex;
        gap: 4px;
        align-items: center;
        flex-wrap: nowrap;
    }

    .xc_action-btns .xc_btn-modern {
        padding: 0 6px;
        height: 26px;
        min-width: 26px;
        font-size: 12px;
    }

    .xc_pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    
    .xc_pagination > .xc_page-btn {
        min-width: 36px;
        height: 36px;
        border-radius: 6px;
        border: 1px solid #ddd;
        background-color: white;
        color: #555;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .xc_pagination > .xc_page-btn:hover:not(.xc_active) {
        border-color: #34495e;
        color: #34495e;
    }
    
    .xc_pagination > .xc_page-btn.xc_active {
        background-color: #34495e;
        color: white;
    }
    
    .xc_pagination > .xc_page-info {
        font-size: 14px;
        color: #7f8c8d;
    }

    .xc_modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .xc_modal-overlay.active {
        display: block;
        animation: xc_fadeIn 0.2s ease;
    }

    @keyframes xc_fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .xc_modal-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: xc_slideIn 0.3s ease;
    }

    @keyframes xc_slideIn {
        from {
            transform: translate(-50%, -48%);
            opacity: 0;
        }
        to {
            transform: translate(-50%, -50%);
            opacity: 1;
        }
    }

    .xc_modal-header {
        position: relative;
        padding: 14px 18px;
        border-bottom: 1px solid #e5e7eb;
        background: #fafafa;
        border-radius: 8px 8px 0 0;
    }

    .xc_modal-title {
        font-size: 16px;
        font-weight: 500;
        color: #374151;
    }

    .xc_modal-close {
        position: absolute;
        top: 12px;
        right: 16px;
        width: 30px;
        height: 30px;
        border: none;
        background: white;
        color: #6b7280;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        transition: all 0.2s;
    }

    .xc_modal-close:hover {
        background: #f3f4f6;
        color: #374151;
        border-color: #9ca3af;
    }

    .xc_modal-body {
        flex: 1;
        padding: 18px 20px;
        overflow-y: auto;
    }

    .xc_form-row {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
    }

    .xc_form-group {
        flex: 1;
        margin-bottom: 10px;
    }

    .xc_form-label {
        display: block;
        font-size: 13px;
        color: #374151;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .xc_form-label .required {
        color: #ef4444;
        margin-left: 2px;
    }

    .xc_form-input {
        width: 100%;
        padding: 6px 10px;
        font-size: 13px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        color: #374151;
        transition: all 0.2s;
        height: 32px;
    }

    .xc_form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .xc_form-textarea {
        width: 100%;
        padding: 6px 10px;
        font-size: 13px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        color: #374151;
        resize: vertical;
        min-height: 60px;
        transition: all 0.2s;
    }

    .xc_form-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .xc_form-select {
        width: 100%;
        padding: 6px 10px;
        font-size: 13px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        color: #374151;
        height: 32px;
        cursor: pointer;
    }

    .xc_modal-footer {
        padding: 14px 18px;
        border-top: 1px solid #e5e7eb;
        text-align: right;
        background: #fafafa;
        border-radius: 0 0 8px 8px;
    }

    .xc_modal-btn {
        padding: 7px 18px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        cursor: pointer;
        margin-left: 10px;
        transition: all 0.2s;
        font-weight: 400;
        background: white;
        color: #374151;
    }

    .xc_modal-btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
        color: #374151;
    }

    .xc_modal-btn-primary {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .xc_modal-btn-primary:hover {
        background: #2563eb;
        border-color: #2563eb;
        color: white;
    }

    .xc_cron-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .xc_cron-inputs .xc_form-input {
        width: 60px;
        text-align: center;
    }

    .xc_cron-label {
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
    }

    .xc_interval-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .xc_interval-inputs .xc_form-input {
        width: 100px;
    }

    .xc_task-type-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .xc_task-type-tab {
        padding: 6px 16px;
        font-size: 13px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
    }

    .xc_task-type-tab.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .xc_task-type-tab:hover:not(.active) {
        background: #f3f4f6;
    }

    .right_col {
        background: #f5f7fa !important;
    }

    .xc_http-method-select {
        width: 80px;
    }

    .xc_http-url-input {
        flex: 1;
    }

    .xc_kv-list {
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background: #fafafa;
        max-height: 150px;
        overflow-y: auto;
    }

    .xc_kv-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        background: white;
    }

    .xc_kv-item:last-child {
        border-bottom: none;
    }

    .xc_kv-item input {
        flex: 1;
        padding: 4px 8px;
        font-size: 13px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        height: 28px;
        min-width: 0;
    }

    .xc_kv-item input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .xc_kv-item .xc_kv-colon {
        color: #6b7280;
        font-weight: 500;
        flex-shrink: 0;
    }

    .xc_kv-item .xc_kv-delete {
        width: 24px;
        height: 24px;
        border: none;
        background: #fef2f2;
        color: #ef4444;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .xc_kv-item .xc_kv-delete:hover {
        background: #fee2e2;
    }

    .xc_kv-add-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 6px;
        border: 1px dashed #d1d5db;
        border-radius: 4px;
        background: white;
        color: #6b7280;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
        margin-top: 4px;
        transition: all 0.2s;
    }

    .xc_kv-add-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        background: #eff6ff;
    }

    .xc_kv-empty {
        padding: 12px;
        text-align: center;
        color: #9ca3af;
        font-size: 13px;
    }
</style>
{% endblock stylesheets %}

{% block content %}

  <div class="right_col" role="main">
    <div class="">
      <div class="row">
          <div class="col-md-12 col-sm-12 col-xs-12">
              <div class="x_panel">
   <!-- xc page start -->
    <div class="xc_container">
        <div class="xc_toolbar">
            <div class="xc_page-title">
                <i class="fa fa-clock-o"></i>
                计划任务
            </div>
            
            <select id="search_status_select" class="xc_status-filter">
                <option value="-1">全部状态</option>
                <option value="1">已启用</option>
                <option value="0">已禁用</option>
            </select>
            
            <input type="text" id="search_text_input" class="xc_search-input" placeholder="任务名称">
            
            <button class="xc_btn-modern" onclick="doSearch()">
                <i class="fa fa-search"></i> 搜索
            </button>
            
            <button class="xc_btn-modern" onclick="openTaskModal('add')">
                <i class="fa fa-plus"></i> 添加
            </button>
            
            <div>
                <span id="top_loading" style="display: none; margin-left: 10px;">
                    <span class="xc_loading-spinner"></span>
                    <span class="xc_loading-text">加载中...</span>
                </span>
                <span id="top_msg"></span>
            </div>
        </div>

        <div class="xc_table-container">
            <table class="xc_table">
                <thead>
                    <tr>
                        <th width="50">ID</th>
                        <th width="120">编号</th>
                        <th>任务名称</th>
                        <th width="60">类型</th>
                        <th width="130">执行时间</th>
                        <th width="60">状态</th>
                        <th width="130">上次执行</th>
                        <th width="130">下次执行</th>
                        <th width="140">操作</th>
                    </tr>
                </thead>
                <tbody id="data">
                </tbody>
            </table>
        </div>
        
        <div class="xc_pagination" id="pageData">
        </div>
    </div>
   <!-- xc page end -->
              </div>
        </div>
      </div>

      <!-- 添加/编辑任务弹窗 -->
      <div class="xc_modal-overlay" id="taskModal">
        <div class="xc_modal-container">
            <div class="xc_modal-header">
                <div class="xc_modal-title" id="modalTitle">添加任务</div>
                <button class="xc_modal-close" onclick="closeTaskModal()">×</button>
            </div>
            <div class="xc_modal-body">
                <div class="xc_form-row">
                    <div class="xc_form-group">
                        <label class="xc_form-label">任务编号</label>
                        <input type="text" id="input_code" class="xc_form-input" disabled>
                    </div>
                    <div class="xc_form-group">
                        <label class="xc_form-label">任务名称<span class="required">*</span></label>
                        <input type="text" id="input_name" class="xc_form-input" placeholder="请输入任务名称">
                    </div>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">任务类型</label>
                    <div class="xc_task-type-tabs">
                        <button type="button" class="xc_task-type-tab active" data-type="cron" onclick="switchTaskType('cron')">定时执行</button>
                        <button type="button" class="xc_task-type-tab" data-type="interval" onclick="switchTaskType('interval')">间隔执行</button>
                    </div>
                </div>

                <div id="cron_config">
                    <div class="xc_form-group">
                        <label class="xc_form-label">执行时间 (Cron表达式)</label>
                        <div class="xc_cron-inputs">
                            <input type="text" id="cron_minute" class="xc_form-input" value="0" placeholder="分">
                            <span class="xc_cron-label">分</span>
                            <input type="text" id="cron_hour" class="xc_form-input" value="*" placeholder="时">
                            <span class="xc_cron-label">时</span>
                            <input type="text" id="cron_day" class="xc_form-input" value="*" placeholder="日">
                            <span class="xc_cron-label">日</span>
                            <input type="text" id="cron_month" class="xc_form-input" value="*" placeholder="月">
                            <span class="xc_cron-label">月</span>
                            <input type="text" id="cron_day_of_week" class="xc_form-input" value="*" placeholder="周">
                            <span class="xc_cron-label">周</span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                            示例: 每天9点30分执行 → 分:30 时:9 其他填 *
                        </div>
                    </div>
                </div>

                <div id="interval_config" style="display: none;">
                    <div class="xc_form-group">
                        <label class="xc_form-label">执行间隔</label>
                        <div class="xc_interval-inputs">
                            <input type="number" id="interval_seconds" class="xc_form-input" value="60" min="1">
                            <span class="xc_cron-label">秒</span>
                        </div>
                    </div>
                </div>

                <div class="xc_form-row">
                    <div class="xc_form-group">
                        <label class="xc_form-label">开始时间</label>
                        <input type="datetime-local" id="input_start_time" class="xc_form-input">
                    </div>
                    <div class="xc_form-group">
                        <label class="xc_form-label">结束时间</label>
                        <input type="datetime-local" id="input_end_time" class="xc_form-input">
                    </div>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">HTTP请求<span class="required">*</span></label>
                    <div style="display: flex; gap: 8px;">
                        <select id="http_method" class="xc_form-select xc_http-method-select">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                        </select>
                        <input type="text" id="http_url" class="xc_form-input xc_http-url-input" placeholder="请输入请求地址">
                    </div>
                </div>

                <div class="xc_form-group">
                    <label class="xc_form-label">请求头</label>
                    <div class="xc_kv-list" id="headers_list">
                        <div class="xc_kv-empty">暂无请求头，点击下方添加</div>
                    </div>
                    <button type="button" class="xc_kv-add-btn" onclick="addKvItem('headers_list', 'Content-Type', 'application/json')">
                        <i class="fa fa-plus"></i> 添加请求头
                    </button>
                </div>

                <div class="xc_form-group" id="http_params_group">
                    <label class="xc_form-label">请求参数 (GET请求使用)</label>
                    <div class="xc_kv-list" id="params_list">
                        <div class="xc_kv-empty">暂无请求参数，点击下方添加</div>
                    </div>
                    <button type="button" class="xc_kv-add-btn" onclick="addKvItem('params_list')">
                        <i class="fa fa-plus"></i> 添加参数
                    </button>
                </div>

                <div class="xc_form-group" id="http_body_group" style="display: none;">
                    <label class="xc_form-label">请求体 (POST请求使用)</label>
                    <div class="xc_kv-list" id="body_list">
                        <div class="xc_kv-empty">暂无请求体参数，点击下方添加</div>
                    </div>
                    <button type="button" class="xc_kv-add-btn" onclick="addKvItem('body_list')">
                        <i class="fa fa-plus"></i> 添加参数
                    </button>
                </div>

                <div class="xc_form-row">
                    <div class="xc_form-group">
                        <label class="xc_form-label">状态</label>
                        <select id="input_state" class="xc_form-select">
                            <option value="1">启用</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                    <div class="xc_form-group">
                        <label class="xc_form-label">备注</label>
                        <input type="text" id="input_remark" class="xc_form-input" placeholder="备注信息">
                    </div>
                </div>
            </div>
            <div class="xc_modal-footer">
                <button class="xc_modal-btn" onclick="closeTaskModal()">取消</button>
                <button class="xc_modal-btn xc_modal-btn-primary" onclick="submitTaskForm()">
                    <span id="submit_loading" style="display: none;">
                        <span class="xc_loading-spinner"></span>
                    </span>
                    <span id="submit_text">提交</span>
                </button>
            </div>
        </div>
      </div>

    </div>
  </div>

      <!-- 日志弹窗 -->
      <div class="xc_modal-overlay" id="logModal">
        <div class="xc_modal-container" style="max-width: 800px;">
            <div class="xc_modal-header">
                <div class="xc_modal-title" id="logModalTitle">执行日志</div>
                <button class="xc_modal-close" onclick="closeLogModal()">×</button>
            </div>
            <div class="xc_modal-body" style="padding: 10px 20px;">
                <table class="xc_table">
                    <thead>
                        <tr>
                            <th width="50">ID</th>
                            <th width="140">请求时间</th>
                            <th width="80">状态</th>
                            <th width="60">耗时</th>
                            <th>响应状态</th>
                            <th width="80">结果</th>
                        </tr>
                    </thead>
                    <tbody id="logData">
                    </tbody>
                </table>
                <div class="xc_pagination" id="logPageData">
                </div>
            </div>
            <div class="xc_modal-footer">
                <button class="xc_modal-btn" onclick="closeLogModal()">关闭</button>
            </div>
        </div>
      </div>

{% endblock content %}

{% block javascripts %}
  {{ block.super }}

<script>
    let eleTopLoading = $("#top_loading");
    let eleTopMsg = $("#top_msg");
    let eleData = $("#data");
    let elePageData = $("#pageData");
    let eleSearchTextInput = $("#search_text_input");
    let eleSearchStatusSelect = $("#search_status_select");
    
    let eleTaskModal = $("#taskModal");
    let eleModalTitle = $("#modalTitle");
    
    let curPage = 1;
    let curPageSize = 12;
    let currentHandle = 'add';
    let currentTaskCode = '';

    function doSearch() {
        curPage = 1;
        f_openIndex(curPage, curPageSize);
    }
    
    eleSearchTextInput.on('keypress', function(e) {
        if (e.which === 13) {
            doSearch();
        }
    });
    
    eleSearchStatusSelect.on('change', function() {
        doSearch();
    });

    function f_show_pageData(pageData) {
        let page_size = pageData["page_size"];
        let html = "";
        html += "<div class='xc_page-info'>共" + pageData["page_num"] + "页 / " + pageData["count"] + "条</div>";
        let pageLabels = pageData["pageLabels"];

        for (let i = 0; i < pageLabels.length; i++) {
            let cur = pageLabels[i]["cur"];
            if (cur === 1) {
                html += "<div class='xc_page-btn xc_active'>" + pageLabels[i]["name"] + "</div>";
            } else {
                html += "<div class='xc_page-btn' onclick='f_openIndex(" + pageLabels[i]["page"] + "," + page_size + ")'>" + pageLabels[i]["name"] + "</div>";
            }
        }
        elePageData.html(html);
    }
    
    function f_openIndex(page, page_size) {
        curPage = page;
        curPageSize = page_size;
        let search_text = eleSearchTextInput.val().trim();
        let search_status = eleSearchStatusSelect.val();
        eleTopLoading.show();
        $.ajax({
            url: '/scheduleTask/openIndex',
            type: "get",
            async: true,
            data: {"p": page, "ps": page_size, "search_text": search_text, "search_state": search_status},
            dataType: "json",
            timeout: 0,
            error: function() {
                eleTopLoading.hide();
                alert("网络异常，请确定网络正常！");
            },
            success: function(res) {
                eleTopLoading.hide();
                if (res.code === 1000) {
                    let data = res.data;

                    if (data.length === 0) {
                        eleData.html("<tr><td colspan='9' class='xc_empty-state'><i class='fa fa-clock-o'></i><p>暂无数据</p></td></tr>");
                        f_show_pageData(res.pageData);
                    } else {
                        eleData.html("");
                        
                        for (let i = 0; i < data.length; i++) {
                            let task = data[i];
                            
                            let taskTypeText = task.task_type === 'cron' ? '定时' : '间隔';
                            let taskTimeText = '';
                            if (task.task_type === 'cron') {
                                taskTimeText = task.cron_minute + '分 ' + task.cron_hour + '时 ' + task.cron_day + '日 ' + task.cron_month + '月 ' + task.cron_day_of_week + '周';
                            } else {
                                taskTimeText = '每' + task.interval_seconds + '秒';
                            }
                            
                            let stateBadge = task.state === 1 
                                ? '<span class="xc_status-badge enabled"><i class="fa fa-check-circle"></i> 启用</span>'
                                : '<span class="xc_status-badge disabled"><i class="fa fa-times-circle"></i> 禁用</span>';
                            
                            let toggleBtn = task.state === 1
                                ? '<button class="xc_btn-modern danger" onclick="f_toggleState(\'' + task.code + '\')">禁用</button>'
                                : '<button class="xc_btn-modern success" onclick="f_toggleState(\'' + task.code + '\')">启用</button>';
                            
                            let item_html = "<tr>";
                            item_html += "<td>" + (task.id || '') + "</td>";
                            item_html += "<td style='font-size: 12px;'>" + task.code + "</td>";
                            item_html += "<td>" + task.name + "</td>";
                            item_html += "<td>" + taskTypeText + "</td>";
                            item_html += "<td style='font-size: 12px;'>" + taskTimeText + "</td>";
                            item_html += "<td>" + stateBadge + "</td>";
                            item_html += "<td style='font-size: 12px;'>" + (task.last_run_time_str || '-') + "</td>";
                            item_html += "<td style='font-size: 12px;'>" + (task.next_run_time_str || '-') + "</td>";
                            item_html += "<td>";
                            item_html += '<div class="xc_action-btns">';
                            item_html += '<button class="xc_btn-modern" onclick="f_edit(\'' + task.code + '\')"><i class="fa fa-pencil"></i></button>';
                            item_html += '<button class="xc_btn-modern" onclick="f_openLogs(\'' + task.code + '\', \'' + task.name + '\')"><i class="fa fa-file-text-o"></i></button>';
                            item_html += '<button class="xc_btn-modern" onclick="f_runNow(\'' + task.code + '\')"><i class="fa fa-play"></i></button>';
                            item_html += toggleBtn;
                            item_html += '<button class="xc_btn-modern danger" onclick="f_confirm_delete(\'' + task.code + '\')"><i class="fa fa-trash"></i></button>';
                            item_html += '</div>';
                            item_html += "</td>";
                            item_html += "</tr>";
                            
                            eleData.append(item_html);
                        }
                        f_show_pageData(res.pageData);
                    }
                } else {
                    eleData.html("<tr><td colspan='9' class='xc_empty-state'><i class='fa fa-exclamation-triangle'></i><p>" + res.msg + "</p></td></tr>");
                    f_show_pageData(res.pageData);
                }
            }
        });
    }

    function f_edit(code) {
        openTaskModal('edit', code);
    }

    function f_confirm_delete(code) {
        let ret = confirm("确认删除该任务吗？");
        if (ret) {
            f_openDel(code);
        }
    }

    function f_openDel(code) {
        eleTopLoading.show();
        $.ajax({
            url: '/scheduleTask/openDel',
            type: "post",
            async: true,
            data: {"code": code},
            dataType: "json",
            timeout: 0,
            error: function() {
                eleTopLoading.hide();
                alert("网络异常，请确定网络正常！");
            },
            success: function(res) {
                eleTopLoading.hide();
                if (res.code === 1000) {
                    f_openIndex(curPage, curPageSize);
                } else {
                    alert(res.msg);
                }
            }
        });
    }

    function f_toggleState(code) {
        eleTopLoading.show();
        $.ajax({
            url: '/scheduleTask/openToggleState',
            type: "post",
            async: true,
            data: {"code": code},
            dataType: "json",
            timeout: 0,
            error: function() {
                eleTopLoading.hide();
                alert("网络异常，请确定网络正常！");
            },
            success: function(res) {
                eleTopLoading.hide();
                if (res.code === 1000) {
                    f_openIndex(curPage, curPageSize);
                } else {
                    alert(res.msg);
                }
            }
        });
    }

    function f_runNow(code) {
        if (!confirm("确认立即执行该任务吗？")) return;
        
        eleTopLoading.show();
        $.ajax({
            url: '/scheduleTask/openRunNow',
            type: "post",
            async: true,
            data: {"code": code},
            dataType: "json",
            timeout: 60000,
            error: function() {
                eleTopLoading.hide();
                alert("网络异常，请确定网络正常！");
            },
            success: function(res) {
                eleTopLoading.hide();
                if (res.code === 1000) {
                    alert("执行成功");
                    f_openIndex(curPage, curPageSize);
                } else {
                    alert(res.msg);
                }
            }
        });
    }

    function openTaskModal(handle, code) {
        currentHandle = handle;
        currentTaskCode = code || '';
        
        if (handle === 'add') {
            eleModalTitle.text('添加任务');
            resetTaskForm();
            loadAddContext();
        } else if (handle === 'edit') {
            eleModalTitle.text('编辑任务');
            resetTaskForm();
            loadEditContext(code);
        }
        
        eleTaskModal.addClass('active');
    }

    function closeTaskModal() {
        eleTaskModal.removeClass('active');
    }

    $('#taskModal').click(function(e) {
        if (e.target === this) {
            closeTaskModal();
        }
    });

    $(document).keydown(function(e) {
        if (e.keyCode === 27 && $('#taskModal').hasClass('active')) {
            closeTaskModal();
        }
    });

    function resetTaskForm() {
        $('#input_code').val('');
        $('#input_name').val('');
        $('#cron_minute').val('0');
        $('#cron_hour').val('*');
        $('#cron_day').val('*');
        $('#cron_month').val('*');
        $('#cron_day_of_week').val('*');
        $('#interval_seconds').val('60');
        $('#input_start_time').val('');
        $('#input_end_time').val('');
        $('#http_method').val('GET');
        $('#http_url').val('');
        $('#input_state').val('1');
        $('#input_remark').val('');
        
        clearKvList('headers_list');
        clearKvList('params_list');
        clearKvList('body_list');
        
        switchTaskType('cron');
    }

    function clearKvList(listId) {
        $('#' + listId).html('<div class="xc_kv-empty">暂无数据，点击下方添加</div>');
    }

    function addKvItem(listId, key, value) {
        let list = $('#' + listId);
        let emptyItem = list.find('.xc_kv-empty');
        if (emptyItem.length > 0) {
            emptyItem.remove();
        }
        
        let itemHtml = '<div class="xc_kv-item">' +
            '<input type="text" class="xc_kv-key" placeholder="键" value="' + (key || '') + '">' +
            '<span class="xc_kv-colon">:</span>' +
            '<input type="text" class="xc_kv-value" placeholder="值" value="' + (value || '') + '">' +
            '<button type="button" class="xc_kv-delete" onclick="removeKvItem(this)"><i class="fa fa-times"></i></button>' +
            '</div>';
        list.append(itemHtml);
    }

    function removeKvItem(btn) {
        let item = $(btn).closest('.xc_kv-item');
        let list = item.parent();
        item.remove();
        
        if (list.find('.xc_kv-item').length === 0) {
            let emptyText = list.attr('id') === 'headers_list' ? '暂无请求头，点击下方添加' : '暂无数据，点击下方添加';
            list.html('<div class="xc_kv-empty">' + emptyText + '</div>');
        }
    }

    function getKvListData(listId) {
        let data = {};
        let list = $('#' + listId);
        list.find('.xc_kv-item').each(function() {
            let key = $(this).find('.xc_kv-key').val().trim();
            let value = $(this).find('.xc_kv-value').val().trim();
            if (key) {
                data[key] = value;
            }
        });
        return JSON.stringify(data);
    }

    function setKvListData(listId, jsonData) {
        clearKvList(listId);
        if (jsonData) {
            try {
                let data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
                for (let key in data) {
                    addKvItem(listId, key, data[key]);
                }
            } catch(e) {}
        }
    }

    function loadAddContext() {
        $.ajax({
            url: '/scheduleTask/openAddContext',
            type: 'get',
            async: true,
            data: {},
            dataType: 'json',
            timeout: 0,
            error: function() {
                alert("加载参数失败，请稍后重试");
            },
            success: function(res) {
                if (res.code === 1000) {
                    let context = res.context;
                    $('#input_code').val(context.code);
                } else {
                    alert(res.msg);
                }
            }
        });
    }

    function loadEditContext(code) {
        $.ajax({
            url: '/scheduleTask/openEditContext',
            type: 'get',
            async: true,
            data: {"code": code},
            dataType: 'json',
            timeout: 0,
            error: function() {
                alert("加载参数失败，请稍后重试");
            },
            success: function(res) {
                if (res.code === 1000) {
                    let context = res.context;
                    $('#input_code').val(context.code);
                    $('#input_name').val(context.name);
                    $('#cron_minute').val(context.cron_minute);
                    $('#cron_hour').val(context.cron_hour);
                    $('#cron_day').val(context.cron_day);
                    $('#cron_month').val(context.cron_month);
                    $('#cron_day_of_week').val(context.cron_day_of_week);
                    $('#interval_seconds').val(context.interval_seconds);
                    if (context.start_time_str) {
                        $('#input_start_time').val(context.start_time_str.replace(' ', 'T'));
                    }
                    if (context.end_time_str) {
                        $('#input_end_time').val(context.end_time_str.replace(' ', 'T'));
                    }
                    $('#http_method').val(context.http_method);
                    $('#http_url').val(context.http_url);
                    setKvListData('headers_list', context.http_headers || '');
                    setKvListData('params_list', context.http_params || '');
                    setKvListData('body_list', context.http_body || '');
                    $('#input_state').val(context.state);
                    $('#input_remark').val(context.remark || '');
                    
                    switchTaskType(context.task_type);
                } else {
                    alert(res.msg);
                }
            }
        });
    }

    function switchTaskType(type) {
        $('.xc_task-type-tab').removeClass('active');
        $('.xc_task-type-tab[data-type="' + type + '"]').addClass('active');
        
        if (type === 'cron') {
            $('#cron_config').show();
            $('#interval_config').hide();
        } else {
            $('#cron_config').hide();
            $('#interval_config').show();
        }
    }

    $('#http_method').change(function() {
        let method = $(this).val();
        if (method === 'GET') {
            $('#http_params_group').show();
            $('#http_body_group').hide();
        } else {
            $('#http_params_group').hide();
            $('#http_body_group').show();
        }
    });

    function validateCronField(value, fieldName, minVal, maxVal) {
        if (value === '*') return true;
        
        if (value.includes('/')) {
            let parts = value.split('/');
            if (parts.length !== 2) return false;
            let base = parts[0];
            let step = parseInt(parts[1]);
            if (isNaN(step) || step < 1) return false;
            if (base !== '*' && isNaN(parseInt(base))) return false;
            if (base !== '*' && (parseInt(base) < minVal || parseInt(base) > maxVal)) return false;
            return true;
        }
        
        if (value.includes('-')) {
            let parts = value.split('-');
            if (parts.length !== 2) return false;
            let start = parseInt(parts[0]);
            let end = parseInt(parts[1]);
            if (isNaN(start) || isNaN(end)) return false;
            if (start < minVal || start > maxVal) return false;
            if (end < minVal || end > maxVal) return false;
            if (start > end) return false;
            return true;
        }
        
        if (value.includes(',')) {
            let parts = value.split(',');
            for (let p of parts) {
                let num = parseInt(p.trim());
                if (isNaN(num) || num < minVal || num > maxVal) return false;
            }
            return true;
        }
        
        let num = parseInt(value);
        if (isNaN(num)) return false;
        if (num < minVal || num > maxVal) return false;
        return true;
    }

    function validateCronExpression() {
        let minute = $('#cron_minute').val().trim();
        let hour = $('#cron_hour').val().trim();
        let day = $('#cron_day').val().trim();
        let month = $('#cron_month').val().trim();
        let dayOfWeek = $('#cron_day_of_week').val().trim();
        
        if (!validateCronField(minute, '分钟', 0, 59)) {
            return { valid: false, msg: '分钟字段格式错误，有效范围: 0-59' };
        }
        if (!validateCronField(hour, '小时', 0, 23)) {
            return { valid: false, msg: '小时字段格式错误，有效范围: 0-23' };
        }
        if (!validateCronField(day, '日期', 1, 31)) {
            return { valid: false, msg: '日期字段格式错误，有效范围: 1-31' };
        }
        if (!validateCronField(month, '月份', 1, 12)) {
            return { valid: false, msg: '月份字段格式错误，有效范围: 1-12' };
        }
        if (!validateCronField(dayOfWeek, '星期', 0, 6)) {
            return { valid: false, msg: '星期字段格式错误，有效范围: 0-6' };
        }
        
        return { valid: true };
    }

    function validateUrl(url) {
        try {
            new URL(url);
            return true;
        } catch(e) {
            return false;
        }
    }

    function validateDateTime(dateTimeStr) {
        if (!dateTimeStr) return { valid: true, value: null };
        let date = new Date(dateTimeStr);
        if (isNaN(date.getTime())) {
            return { valid: false, msg: '日期时间格式错误' };
        }
        return { valid: true, value: date };
    }

    function submitTaskForm() {
        let name = $('#input_name').val().trim();
        if (!name) {
            myToast2025("请输入任务名称", "error");
            return;
        }
        if (name.length > 100) {
            myToast2025("任务名称不能超过100个字符", "error");
            return;
        }

        let http_url = $('#http_url').val().trim();
        if (!http_url) {
            myToast2025("请输入请求地址", "error");
            return;
        }
        if (!validateUrl(http_url)) {
            myToast2025("请求地址格式错误，请输入有效的URL", "error");
            return;
        }

        let taskType = $('.xc_task-type-tab.active').data('type');
        if (taskType !== 'cron' && taskType !== 'interval') {
            myToast2025("任务类型错误", "error");
            return;
        }
        
        if (taskType === 'cron') {
            let cronResult = validateCronExpression();
            if (!cronResult.valid) {
                myToast2025(cronResult.msg, "error");
                return;
            }
        }
        
        let intervalSeconds = parseInt($('#interval_seconds').val());
        if (taskType === 'interval') {
            if (isNaN(intervalSeconds) || intervalSeconds < 1) {
                myToast2025("间隔秒数必须大于0", "error");
                return;
            }
            if (intervalSeconds > 86400) {
                myToast2025("间隔秒数不能超过86400秒（24小时）", "error");
                return;
            }
        }

        let startTimeStr = $('#input_start_time').val().trim();
        let endTimeStr = $('#input_end_time').val().trim();
        
        let startTimeResult = validateDateTime(startTimeStr);
        if (!startTimeResult.valid) {
            myToast2025("开始时间格式错误", "error");
            return;
        }
        
        let endTimeResult = validateDateTime(endTimeStr);
        if (!endTimeResult.valid) {
            myToast2025("结束时间格式错误", "error");
            return;
        }
        
        if (startTimeResult.value && endTimeResult.value) {
            if (startTimeResult.value >= endTimeResult.value) {
                myToast2025("开始时间必须早于结束时间", "error");
                return;
            }
        }

        let httpMethod = $('#http_method').val();
        if (httpMethod !== 'GET' && httpMethod !== 'POST') {
            myToast2025("HTTP方法错误", "error");
            return;
        }

        let state = parseInt($('#input_state').val());
        if (state !== 0 && state !== 1) {
            myToast2025("状态值错误", "error");
            return;
        }

        let remark = $('#input_remark').val().trim();
        if (remark.length > 200) {
            myToast2025("备注不能超过200个字符", "error");
            return;
        }
        
        let data = {
            "code": currentHandle === 'add' ? $('#input_code').val() : currentTaskCode,
            "name": name,
            "task_type": taskType,
            "cron_minute": $('#cron_minute').val(),
            "cron_hour": $('#cron_hour').val(),
            "cron_day": $('#cron_day').val(),
            "cron_month": $('#cron_month').val(),
            "cron_day_of_week": $('#cron_day_of_week').val(),
            "interval_seconds": $('#interval_seconds').val(),
            "start_time": $('#input_start_time').val(),
            "end_time": $('#input_end_time').val(),
            "http_method": $('#http_method').val(),
            "http_url": http_url,
            "http_headers": getKvListData('headers_list'),
            "http_params": getKvListData('params_list'),
            "http_body": getKvListData('body_list'),
            "state": $('#input_state').val(),
            "remark": $('#input_remark').val()
        };

        let handleUrl = currentHandle === 'add' ? '/scheduleTask/openAdd' : '/scheduleTask/openEdit';

        $('#submit_loading').show();
        $('#submit_text').text('提交中...');

        $.ajax({
            url: handleUrl,
            type: "post",
            async: true,
            data: data,
            dataType: "json",
            timeout: 0,
            error: function() {
                $('#submit_loading').hide();
                $('#submit_text').text('提交');
                myToast2025("网络异常，请确定网络正常！", "error");
            },
            success: function(res) {
                $('#submit_loading').hide();
                $('#submit_text').text('提交');

                if (res.code === 1000) {
                    myToast2025(res.msg, "success");
                    setTimeout(function() {
                        closeTaskModal();
                        f_openIndex(curPage, curPageSize);
                    }, 500);
                } else {
                    myToast2025(res.msg, "error");
                }
            }
        });
    }

    let currentLogTaskCode = '';
    let currentLogPage = 1;

    function f_openLogs(taskCode, taskName) {
        currentLogTaskCode = taskCode;
        currentLogPage = 1;
        $('#logModalTitle').text(taskName + ' - 执行日志');
        $('#logModal').addClass('active');
        loadLogData(currentLogPage);
    }

    function closeLogModal() {
        $('#logModal').removeClass('active');
    }

    $('#logModal').click(function(e) {
        if (e.target === this) {
            closeLogModal();
        }
    });

    function loadLogData(page) {
        currentLogPage = page;
        $.ajax({
            url: '/scheduleTask/openLogs',
            type: 'get',
            async: true,
            data: {"task_code": currentLogTaskCode, "p": page, "ps": 10},
            dataType: 'json',
            timeout: 0,
            error: function() {
                $('#logData').html("<tr><td colspan='6' class='xc_empty-state'>网络异常</td></tr>");
            },
            success: function(res) {
                if (res.code === 1000) {
                    let data = res.data;
                    if (data.length === 0) {
                        $('#logData').html("<tr><td colspan='6' class='xc_empty-state'><i class='fa fa-file-text-o'></i><p>暂无执行日志</p></td></tr>");
                    } else {
                        $('#logData').html('');
                        for (let i = 0; i < data.length; i++) {
                            let log = data[i];
                            let resultBadge = log.is_success === 1 
                                ? '<span class="xc_status-badge enabled">成功</span>'
                                : '<span class="xc_status-badge disabled">失败</span>';
                            
                            let spendTime = '';
                            if (log.request_time_str && log.response_time_str) {
                                try {
                                    let t1 = new Date(log.request_time_str.replace(/\//g, '-'));
                                    let t2 = new Date(log.response_time_str.replace(/\//g, '-'));
                                    spendTime = Math.round((t2 - t1) / 1000) + 's';
                                } catch(e) {
                                    spendTime = '-';
                                }
                            }
                            
                            let itemHtml = '<tr>';
                            itemHtml += '<td>' + (log.id || '') + '</td>';
                            itemHtml += '<td style="font-size: 12px;">' + (log.request_time_str || '-') + '</td>';
                            itemHtml += '<td>' + log.http_method + '</td>';
                            itemHtml += '<td>' + spendTime + '</td>';
                            itemHtml += '<td style="font-size: 12px;">' + (log.response_status || '-') + '</td>';
                            itemHtml += '<td>' + resultBadge + '</td>';
                            itemHtml += '</tr>';
                            $('#logData').append(itemHtml);
                        }
                    }
                    showLogPageData(res.pageData);
                } else {
                    $('#logData').html("<tr><td colspan='6' class='xc_empty-state'>" + res.msg + "</td></tr>");
                }
            }
        });
    }

    function showLogPageData(pageData) {
        let html = "";
        html += "<div class='xc_page-info'>共" + pageData["page_num"] + "页 / " + pageData["count"] + "条</div>";
        let pageLabels = pageData["pageLabels"];
        for (let i = 0; i < pageLabels.length; i++) {
            let cur = pageLabels[i]["cur"];
            if (cur === 1) {
                html += "<div class='xc_page-btn xc_active'>" + pageLabels[i]["name"] + "</div>";
            } else {
                html += "<div class='xc_page-btn' onclick='loadLogData(" + pageLabels[i]["page"] + ")'>" + pageLabels[i]["name"] + "</div>";
            }
        }
        $('#logPageData').html(html);
    }

    window.onload = function() {
        f_openIndex(curPage, curPageSize);
    };
</script>
{% endblock javascripts %}
